\documentclass[11pt]{article}

\input strowpreprint

\newcommand{\kc}{\textsf{kCARTA}\xspace}

\lhead{\textsf{\textbf{DRAFT}}}

\title{kCARTA : A Fast Pseudo Line by Line Radiative Transfer Algorithm with
                Analytic Jacobians, Scattering and NonLocal Thermodynamic 
                Equilibrium Radiative Transfer}

\author{Sergio De Souza-Machado, L. Larrabee Strow,\\
       Howard E. Motteler, and Scott E. Hannon\\
       University of Maryland Baltimore County, Baltimore, MD 21250 USA}

\begin{document}

\maketitle

\begin{abstract}
  
  Using a custom line-by-line spectroscopic code, a radiative transfer package
  using a monochromatic \textsf{SVD} compressed database has been developed. 
  The database 
  contains the spectroscopic absorption coefficients for all the relevant
  atmospheric gases in the 605 $cm^{-1}$ to 2830 $cm{-1}$ region, with a 
  point spacing of 0.0025 $cm^{-1}$. The \cd database is computed using our 
  latest estimates of line mixing and duration of collision parameters. The 
  code can output monochromatic optical depths and/or transmittances, 
  radiances, jacobians and fluxes. The clear sky radiative transfer model 
  uses a layer-varying diffusivity angle at each spectral point to compute the 
  background thermal radiation quickly and accurately. Clear sky analytic 
  Jacobians with respect to layer gas amount and layer temperature can be 
  rapidly computed by the code. Scattering computations for both downlook and
  uplook instruments can be performed using our own \textsf{kTWOSTREAM} 
  scattering code, or either of \textsf{DISORT} or \textsf{RTSPEC}.
  The code can also be used to compute the effects of Non Local Thermodynamic
  Equilibrium in the upper atmosphere. The package has been tested extensively
  for clear sky radiative transfer cases, using data from field campaigns such
  as CAMEX-1 and CLAMS, and preliminary AIRS data.
  We use three case studies to illustrate use of the package. First, three 
  instruments of differing resolution are used to determine which would be 
  most suitable to use to measure high altitude water vapor. These ideal 
  results demonstrate that the highest resolution instrument is best, as it 
  has several channels whose water Jacobians peak high up in 
  the atmosphere. The second case study is to determine the sizes of the
  various contributing derivative terms (Planck radiance versus weighting 
  functions) in the temperature Jacobians. We show that the derivative of the 
  Planck term contributes the most. The third case study compares the three 
  scattering codes to each other and to actual data, concentrating on the 
  infrared window regions.

\end{abstract}

\section{Introduction}

\subsection{Spectroscopic line-by-line codes}

When using the spectra produced by spectroscopy codes in radiative transfer
algorithms, the accuracy of these codes is especially important.
For example, line mixing and far-wing effects have to be correctly and
accurately incorporated into lineshapes, as atmospheric parameters 
such as temperature and humidity as a function of atmospheric height can be
retrieved using information in spectral regions dominated by these effects. 
While these codes can be very accurate, when compared to experimentally 
obtained laboratory spectra, they are usually too slow for practical 
``on-the-fly'' applications.

One approach to implement line mixing or far wing effects is to add on a 
continuum, or to use a chi function to  multiply a Voigt or Lorentz 
lineshape. While an empirical continuum is easy to implement in a 
line-by-line code, our recent
work has shown that for water, non-Lorentz line shapes must be used
close to the line centers, a complicating factor in traditional
implementations of line-by-line codes. Similarly, line mixing effects
in between \cd lines in the 4.3 and 15 $\mu$m regions are also complicated.
These problems are not impossible to deal with, but they significantly 
complicate codes that are already difficult to develop and maintain.

The upcoming generation of nadir viewing satellite instruments for
remote sensing of atmospheric temperature and humidity profiles will
require accurate forward models for radiative transfer.  This is a
rather demanding task since these new instruments, such as the
Atmospheric InfraRed Sounder (AIRS)\cite{air:91}, have thousands of
low-noise spectral channels throughout the infrared.  Physical
retrieval algorithms using these high-resolution radiances require the
rapid computation of accurate radiances at the instrument spectral
resolution.  This is usually achieved by parameterizing effective
layer transmittances at the instrument spectral resolution as a
function of the temperature and constituent profile, for a wide 
variety of atmospheric profiles. To do this, monochromatic transmittances 
need to be generated for the large number of atmospheric profiles. This 
is a cumbersome task with line-by-line codes, given that spectral 
resolutions on the order of 0.0005 \wn\ are required over almost 2500 \wn.  
Although reducing this
tedious computation was the motivating force behind the development of
the work presented here, there are many other applications that
require copious, and slow, line-by-line computations.

\subsection{Combining spectroscopy and radiative transfer algorithms}
The problem of code maintenance is compounded if one wants to combine a 
spectroscopy code with a detailed radiative transfer code. For example, there
could be updates to the computation machinery required for the spectroscopy of
any one of the gases, such as line mixing for \cd, or the release of new
line parameters in the \textsf{HITRAN} database. Another update could be 
including and refining a radiative transfer algorithm with the code.

For the reasons presented above, we developed a highly compressed precomputed 
database of monochromatic atmospheric optical depths that is accurate, 
relatively small, and easy to use.  Generation of monochromatic transmittances
from this database for an arbitrary Earth atmosphere temperature, pressure 
and gas amount profile is orders of magnitude faster than using a 
line-by-line code. We call this the kCompressed Database. For each gas that
is radiatively important in the infrared region, the database 
consists of binary files in blocks of 25 $cm^{-1}$. While the ``line-by-line''
code that is used to generate the spectroscopic database can be slow and 
complicated, these details do not trouble the user of the kCompressed 
Database, as all that is required is an algorithm to uncompress the database 
for a given profile. To update the spectroscopy in a selected wavenumber 
region for a specified gas is now trivial, as all that is required is the 
relevant updated  file in the kCompressed database. 

In addition to the uncompression algorithm that computes spectra for the
desired atmospheric profile, we have developed clear sky radiative transfer 
algorithms for both a downlooking and an uplooking instrument. Radiances 
computed using the compressed database are as accurate as those computed with
a line-by-line code since our compression procedure introduces errors well 
below spectroscopy errors. Although this method {\em is} much slower than 
fast forward models based on effective convolved transmittances, it is much 
more accurate. 

Twice daily global coverage of the Earth by the AIRS (Atmospheric
InfraRed Sounder) instrument, has provided 
us with radiometrically accurate data throughout the infrared
region. AIRS is a high resolution infrared instrument launched on
board NASA's AQUA platform in May 2002, with 2378 channels spanning
the infrared region from 650 to 2700 \wn. The resolution of the
channels is given by $\nu/1200$, giving FWHM of
approximately 0.5 \wn and 2 \wn at 650,2400 \wn respectively. The Fast
Forward Clear Sky Algorithm for AIRS is developed from \kc \cite{str:02*2}.
The radiometric accuracy of AIRS is better than 0.5 K in the
10 \um and 3.7 \um window regions \cite{aum:02*2}. This high
resolution spectrally accurate data has enabled us to fine tune some
of the spectroscopy used in the kCompressed Database, such as the 4.3
micron \cd $R$ branchead, and the water
continuum coefficients in the 6.7 micron water vapor region. Additionally, 
the instrument has provided us with the first high resolution nadir data of 
Non Local Thermodynamic Equilibrium (NLTE) in the 4 micron \cd band. Above 
45 km, solar pumping during the day
significantly alters the vibrational temperatures from the local kinetic 
temperatures in this band, with the observed brightness temperatures being 
enhanced by almost 8 K in this region. \textsf{KCARTA} now includes a 
line-by-line NLTE model with Cousin linemixing in this region; in the future
we will be speeding up this code by using a lookup table of spectral and Planck
function modifiers, based on solar zenith angle.

We have also developed and/or interfaced packages to compute radiative 
transfer in the presence of scattering media such as clouds or aerosol layers.
Two well known scattering  algorithms have been interfaced with 
\textsf{KCARTA}. The first is \textsf{RTSPEC}, which uses a hybrid single 
scattering/Eddington approach \cite{dee:98}. Included in this package is 
code to compute Mie scattering tables for ice or water particle distributions,
as well as modifications to compute these tables for some of the aerosols in 
the \textsf{OPAC} database \cite{hes:98}. These tables drive all of the 
scattering computations of \textsf{KCARTA}. \textsf{RTSPEC} runs very rapidly,
but does not include the effects of (solar) beam scattering. By interfacing 
\textsf{DISORT} \cite{stam:88} with our package, we can include the effects of
solar beam scattering. However, this code does not run very fast, as it has to
perform a large number of matrix inversions at each spectral point. We have 
developed a rapid \textsf{kTWOSTREAM} scattering code that includes the 
effects of beam scattering. As has been done in the \textsf{CHARTS} 
\cite{mon:97} scattering code, \textsf{kTWOSTREAM} computes the reflection, 
transmission and layer emission of individual layers, adding them together to 
compute the overall scattering effects. \textsf{kTWOSTREAM} differs from 
\textsf{CHARTS} in that we only allow for two streams, and that we compute 
the radiative transfer individually on every spectral point, instead of 
building up a ``distribution'' to speed up the code.

Combining all the above features, we have a rapid and accurate code that 
computes the 
monochromatic atmospheric transmittances for different gas combinations, as
well as computing the monochromatic radiance. The whole package is called 
\textsf{kCARTA}, which stands for ``kCompressed Atmospheric Radiative 
Transfer Algorithm.''  This is an infrared ``monochromatic'' radiative 
transfer algorithm written for a one dimensional Earth atmosphere. 

We point out here that \textsf{kCARTA} should not be used for limb viewing, 
especially when using very high resolution instruments high in the
atmosphere. This is mainly a limitation for ballon borne instruments that can 
have very high spectral resolution.

\section{Overview of kCompressed Database and \textsf{kCARTA}}

Our own custom line-by-line code is used to compute the spectra for an 
uncompressed database of look-up tables. For each gas, this database 
consists of the spectra 
for a US Standard Atmosphere, as well as ten temperature offsets of the US 
Standard temperature profile. The spectra are then compressed, using a 
Singular Value Decompostion, to produce the kCompressed Database. The 
accuracy of \textsf{KCARTA} is then limited by the accuracy of the compressed 
database, and is discussed in reference \cite{str:97}. The implementation of 
the compression can be changed quite easily as necessary. Ultimately, it is 
the accuracy of the spectroscopy of the line-by-line code that limits 
\textsf{kCARTA}. This depends on the accuracy of the \textsf{HITRAN} line 
parameters, and the lineshape models that use the parameters. 

The current kCompressed database spans 605 \wn to 2830 \wn, broken up into 
chunks that are 25 \wn wide. The point spacing of the database is fixed at 
0.0025 \wn, which is an average over five points spaced at 0.0005 \wn. In the 
near future, we plan to extend the database to the Far IR (65 \wn to 605 \wn),
and will then use a more natural point spacing. The chosen point spacing will 
resolve the narrowest lines, which would be the doppler lines higher up in 
the atmosphere, whose widths vary both with 
temperature and wavenumber. A Voigt/Van-Huber lineshape is used for almost
all molecules; exceptions include water, where we use the ``without basement''
plus continuum shapes, \cd where we include the effects of line mixing and 
duration of collision parameters, nitrogen and oxygen that include the
continuums, and the ``cross section gases.''

The default layering of the atmosphere is such that it is divided into one 
hundred layers, with the highest pressure level being 1100 mb and the lowest 
being 0.005 mb. The layers at the bottom of the atmosphere are about 200 m 
thick, 
and gradually get thicker as the height increases. These pressure layers are 
the same as those used for the AIRS Fast Forward Model, 
as {\sf kCARTA} is the AIRS ``Reference Forward Model.''  
The pressure layers were chosen such that there would be less that 0.1 K 
brightness temperature errors in the simulated AIRS radiances. The 
temperatures and gas amounts in the spectroscopic database are from the 
U.S. 1962 Standard 
Profile, as well as five temperature offsets (in increments of $\pm$ 10K) on 
either side of the Standard Profile.  The current spectroscopic compressed 
tables uses the line parameters from the \textsf{HITRAN98} database, as well
as the Toth water lines.

To compute the absorption coefficients for an arbitrary profile, the look-up 
tables are (cubic) spline interpolated in temperature, and scaled in gas 
absorber amount.  These splines allow us to easily compute the analytic 
temperature derivatives, from which \textsf{kCARTA} can compute temperature 
Jacobians. Having obtained the absorption coefficients for a single gas, the 
cumulative optical depth for each layer in the atmosphere
can be obtained by adding together the individual gas optical depths, 
appropriately weighted. \textsf{kCARTA} can output the individual optical 
depths, and also the cumulative depths. Note that the user is not limited to
using only the AIRS 100 layers; we include source code that allows the user 
to layer the atmosphere as coarsely or as finely as desired. 

For a downward looking instrument in a clear sky, the surface term and layer 
emission terms are automatically included in the radiative transfer 
calculation.  In addition, reflected thermal and solar tems can also be 
included. This is depicted in Figure \ref{fig:fig1}. Dropping the surface 
and reflected thermal terms enables \textsf{kCARTA} to compute the radiance 
measured by an upward looking instrument as well.  The program can either 
assume a plane parallel atmosphere, or include effects on the satellite 
viewing angle due to the curvature of the earth.

\begin{figure}
\includegraphics{paper1_fig1.eps}
  \caption{The contributions to the radiance measured by a downlooking 
    instrument (1) surface term (2) layer emission term (3) thermal 
    background term (4) solar term.}
  \label{fig:fig1} 
\end{figure} 

By differentiating the radiance equation with respect to a layer gas
amount or temperature, the radiance Jacobian is obtained. Jacobians
are very useful in demonstrating to which part of the atmosphere the
radiance is most sensitive, to a change in the amount of one of
its constituents and/or temperature. Fluxes can be computed
by computing radiance intensities at various angles for each layer.

The speed and features of the code make it an alternative to other
existing ``line by line'' codes such as \textsf{GENLN2} and \textsf{LBLRTM}.
The accuracy of the database has been extensively compared to {\sf
GENLN2}. \textsf{kCARTA} contains the latest spectroscopy/lineshape 
information.  In addition, the transmittances computed by \textsf{kCARTA} are 
smooth and well behaved, allowing people to develop fast-forward models. The 
inclusion of some scattering codes into the package has increased the
utility of the package. Output from running \textsf{kCARTA} can be read using 
f77 code, or Matlab code. 

\section{Spectroscopic Compressed Database description}

Here we present a short overview of the algorithms used to first produce and 
then compress the spectroscopic database. For a more detailed description,
the interested reader is referred to \cite{str:97}.

To be able to compute the monochromatic spectral radiances for upcoming 
infrared satellite viewing instruments such as AIRS, optical depths were 
computed for a spectral region that extends from 605 \wn to 2830 \wn. The 
computation of the look-up table of monochromatic optical depths was 
performed with our own custom line by line code, at a point spacing of 
0.0025 \wn. This is a 5 point box car average over a spacing of 0.0005 \wn.

The custom line-by-line code uses the spectral line parameters in the 
\textsf{HITRAN98} database; new and corrected water line parameters from 
the \textsf{Toth} database have also been included. We have performed simple
tests against the \textsf{HITRAN2000} database, and satisfied ourselves that 
the current database is accurate. The \textsf{MATLAB} 
line-by-line code closely matches the line-by-line computations of 
\textsf{GENLN2}\cite{edw:92}, but has been refined so that the spectral lines
are sorted into a ``near by '' bin, a ``far away'' bin and an additional 
``medium distance'' bin. 

Having our own line-by-line code facilitates fine 
tuning any spectroscopic computations, as will be discussed in the next 
section. For example, we have been able to incorporate and fine tune a suite 
of linemixing code for the 4.3 and 15 micron \cd bands.
Optical depths due to the ``cross sectional'' gases (whose absorption cross 
sections are too complicated to be easily modeled by a line-by-line code) are 
computed by carefully interpolating and/or extrapolating the sparse 
(pressure,temperature) data available in the \textsf{HITRAN} database.

100 pressure layers were used (average pressure less than 0.01 
to 1060 millibar), at 11 temperature profiles (US Standard Reference
Temperature, plus five temperature offsets on either side of the
reference $\pm 10 K ... \pm$ 50 K). Breaking up the above wavenumber
spread into 25 \wn wide regions, the gases selected for inclusion in
the database in each 25 \wn region were those that would have a
measurable effect on the AIRS (and similar satellites) radiances.  As
optical depths generally vary smoothly in temperature, and are
linearly related to gas amount \cite{str:97}, the lookup table can be
used to interpolate in temperature and then scaled in absorber amount, to
obtain the gas absorption coefficients for an arbitrary atmospheric profile.

As described above, the lookup table is 35 Gbytes in size, and would require
storage on media such as a hard disk. This could pose problems when,
for example, distributing updates in the spectroscopy amongst users of
the table.  For this reason, the lookup table was compressed using
Singular Value Decomposition (SVD), which is briefly explained below.

Conceptually, a $m \times n$ matrix of absorption coefficients 
$\mathbf{K_{(g)}}$ for gas $g$ can be factored as
\begin{equation}
K_{(g)} = U \Sigma V^{T}
\end{equation}
where the diagonals of $\Sigma$ are the singular values of $K_{(g)}$
and are usually ordered from largest to smallest. Here the dimensions
of the matrix, $m,n$, are the number of wavenumber points and the
(pressure) layering of the atmosphere. The matrix sizes in this case
are $U = m \times n, \Sigma = n \times n, V = n \times n$. When many
of the singular values of $K_{(g)}$ are small, then $K_{(g)}$ can be
rewritten as
\begin{equation}
K_{(g)(ij)} = \sum_{k=1}^{L} U_{ik} \sigma_{k} V_{jk} + 
         \sum_{k=L+1}^{N} U_{ik} \sigma_{k} V_{jk}
\end{equation}
and the second term dropped. This leads to the truncated matrix sizes
of $U = m \times L, \Sigma = L \times L, V = n \times L$. Hereafter,
we assume that $U,\Sigma,V$ refer to the more compact matrices.  Note
that the columns of matrix $U$ form an orthonormal basis set for the
matrix $K_{(g)}$, denoted by $\Psi_{l}$.

This SVD technique was used to compress the lookup table that was generated by
our custom line by line code. Using the terminology introduced above, the
monochromatic absorption coefficient for each gas, $K_{(g)}$ matrix,
for each 25 $cm^{-1}$ wavenumber region (at a point spacing of 0.0025
$cm^{-1}$), for 100 pressure layers at 11 temperatures can be
represented as
\begin{equation}
K_{(g)(10000 freqs \times 100 layers \times 11 temps)} = U \Sigma V^{T}
\end{equation}

As the monochromatic optical depths change smoothly with pressure.
typically far fewer than 50 basis vectors were needed to reconstruct
any optical depths \cite{str:97}. The number of basis vectors used to
reconstruct the optical depths were such that the maximum brightness
temperature error was $\le$ 0.075 K \cite{str:97}. Therefore, instead
of storing the original $k$ matrix, the truncated SVD decomposition is
saved :
\begin{equation}
K^{compact}_{(g)(10000 freqs \times 100 layers \times 11 temps} = 
\Sigma V^{T}
\end{equation}  
as well as the matrix of basis vectors $U$. 

One can easily invert the above equation to obtain the monochromatic
absorption coefficient matrix for gas $g$, $K_{(g)}$.  When
reconstructing the $K_{(g)}$ matrix for a particular gas, relevant to
a particular profile, the \textsf{kCARTA} algorithm simply interpolates
the basis vectors in temperature, and scales for the gas amount as
ratioed to the reference gas amount :
\begin{equation}
K_{m(g)}(\nu) = \frac{q_{m(g)}}{q^{ref}_{m(g)}}
                \sum_{l=1}^{L} c_{l(g)}(T_{m},m) \Psi_{l}
\end{equation}
where $\Psi_{l}$ are the basis vectors (obtained from the truncated
matrix $U$) and $ c_{l(g)}(T_{m},m)$ are the interpolated coefficients
(obtained from the truncated decomposition $\Sigma V^{T}$). Here $m$
is the layer at which we want the absorption coefficients for gas $g$.

To account for the self broadening of water, monochromatic lookup tables were 
generated for the reference water amount,  multiplied by 0.1,1.0,3.3,6.7 and 
10.0 (as mentioned above, the ``without basement'' water lineshape is stored 
in the compressed database). Performing a sequential decomposition,
five compressed $k_{compact}$ matrices were stored for each wavenumber 
region.  To regenerate the water absorption coefficients using \textsf{kCARTA}
requires a temperature and water amount interpolation
\begin{equation}
k_{m(water)}(\nu) = \sum_{l=1}^{L} c_{l(g)}(T_{m},m,q_{m}) \Psi_{l}
\end{equation}
Any one of four CKD water continuum models  (versions 0, 2.1, 2.3 or 2.4) 
can be added on, to obtain the total optical depth due to water. 

As mentioned above, the original lookup tables obtained directly from our 
custom line by line code occupied $\simeq$ 35 Gbytes. Using the SVD technique,
the monochromatic absorption coefficients were then compressed to a much more 
manageable size of $\simeq$ 450 Mbytes, which is what is referred to as the 
\textsf{kCARTA} Compressed database. Since the absorption coefficients vary 
smoothly in temperature and pressure, the compressed tables can be interpolated
to compute the optical depths for any realistic Earth atmosphere temperature 
profile, at any realistic pressure layering. 

\section{Validation of the Spectroscopic Compressed Database}

As mentioned above, having our own line-by-line code facilitates fine tuning 
any spectroscopic computations. This is done after carefully analyzing radiance
spectra from validated aircraft or space instrument campaigns for noticeable
errors, going back to high resolution laboratory data and changing necessary
parameters such that the new spectroscopy improves agreement agrees $both$ 
with the laboratory data and the radiance data.

For instance the \cd database was computed using our latest 
estimates of the line mixing and duration of collision parameters in the 
important 4um and 15um regions. Comparisons of actual spectra obtained in 
recent campaigns against simulations using the new \cd spectroscopy versus 
other \cd lineshapes such as that in the older line mixing spectroscopy of 
\textsf{GENLN2} vindicates the results. One example is zooming into the 
15 micron \cd temperature sounding region. Figure \ref{fig:15umcompare}
is a plot of the brightness temperature differences in the 705 - 750 \wn 
region. 

The top panel is a averaged AIRS brightness temperature spectrum, where
we have ensured that only clear fields of view are used in the average. 
The AIRS Fast Forward Model assumes that the observation is through a 
clear atmosphere, and so great care was taken to ensure that we were 
pulling out "clear sky radiances" from the AIRS data \cite{des:02*2}. 
This included filtering the data through a very rigorous set of 
requirements, that included ensuring observed brightness temperatures in 
the 4 and 10 \um windows differed by less than 0.5 K; also, since thne sea 
surface emissivity is much more accurately known than land emissivities, 
the observations chosen are all over sea or ocean masses. \cite{des:02*2}

The bottom panel shows differences betweeen observed and computed 
brightness temperatures, using kCARTA-linemixing (blue) versus 
GENLN2-Cousin (red). The temperature 
and humidity fields used in the simulations are from the European Center for
Medium Range Weather Forecasting, colocated as closely as possible in time and
space with the corresponding AIRS observations. The circles in both panels are
the regions ``in-between'' the lines, which have the most transperancy and thus
most useful for temperature sounding. Clearly the linemixing spectroscopy 
gives smaller biases than the Cousin lineshape spectroscopy. 

\begin{figure}
\includegraphics[width=4.0in]{../EUROPTO/Crete02/SLIDES/MOREFIGS/kcarta-vs-genln2-g005.eps}
  \caption{Simulations using different lineshapes compared to validated 
           spectra in the 15 micron region}
  \label{fig:15umcompare} 
\end{figure} 

Another important example of comparing linemixing versus Cousin lineshapes
is obtained by zooming into the 
temperature sounding 2385 - 2400 \wn region,  Figure \ref{fig:4.3umcompareA} 
plots the  $observations - calculations$ for the \textsf{WINTEX} and 
\textsf{CAMEX 3} campaigns. Compared to Cousin lineshapes, the new linemixing 
spectroscopy significantly reduces the brightness temperature simulation 
differences with data. However we did not have many validated spectra from 
these campaigns, which meant we could not average out noise in the data to 
unmask possible spectroscopic errors.

\begin{figure}
\includegraphics[width=4.0in]{../EUROPTO/FlorenceSept99/FIGURES/4p3micronwintexcamex.eps}
  \caption{Simulations using different lineshapes compared to validated 
           spectra in the 4.3 micron region}
  \label{fig:4.3umcompareA} 
\end{figure} 

Launched on May 4, 2002, the $AIRS$ instrument provided us with many 
thousands of infrared radiance spectra at the top of the atmosphere. Averaging
these spectra, we could reduce the noise and thus further finetune the \cd 
linemixing spectroscopy in the 2385 - 2400 \wn region, while at the same time
ensuring consistentency with the laboratory data. 
Figure \ref{fig:4.3umcompareB}
plots the  $observations - calculations$ for the \textsf{AIRS} data, for early
refinements of the linemixing lineshape. The top 
panel shows a typical averaged AIRS spectrum. The bottom panel shows three  
different simulations, with the temperature and humidity fields once 
again from the ECMWF forecasts. The green curve shows errors using the Cousin
lineshape. The blue curve shows the original linemixing spectroscopy results.
Though once again, they are better than the Cousin lineshape results, it was
evident that there needed to be improvements. The red curve in the same 
panel showed the results of one series of refinements. 

\begin{figure}
\includegraphics[width=4.0in]{../EUROPTO/Crete02/SLIDES/MOREFIGS/fig5.eps}
  \caption{Simulations using different lineshapes compared to validated 
           spectra in the 4.3 micron region. Lineshapes are Cousin (from 
           GENLN2) and two iterations of linemixing lineshapes}
  \label{fig:4.3umcompareB} 
\end{figure} 

Figure \ref{fig:4.3umcompareC}
plots the  $observations - calculations$ for the \textsf{AIRS} data, for
newer refinements of the linemixing lineshape. The top 
panel shows a typical averaged AIRS spectrum. The bottom panel shows two 
different KCARTA simulations, with the temperature and humidity fields once 
again from the ECMWF forecasts. The red curve in the bottom 
panel shows one degree of refinement of the linemixing spectroscopy beyond that
shown in Figure \ref{fig:4.3umcompareB}, while the blue curve in the same 
panel shows the latest refinements. 

\begin{figure}
\includegraphics[width=4.0in]{EPS_FILES/4p3um_new.eps}
  \caption{Simulations using latest linemixing compared to AIRS spectral data 
           in the 4.3 micron region. Lineshapes are newer iterations of 
           linemixing lineshapes}
  \label{fig:4.3umcompareC} 
\end{figure} 

The nitrogen (N2) and oxygen (O2) spectra include the latest estimates of 
their respective continuums \cite{laf:96,thi:97}.  The water 
database was computed using the  ``without  basement'' lineshape, so that any
one of the four CKD continuums can be added on (versions 0, 2.1, 2.3 or 2.4); 
in the future we could slightly change these lineshapes by multipling the 
``without  basement'' lineshapes by  $\chi$-functions \cite{tob:96*1}. Though
the successive CKD versions have indeed shown significant improvements, in 
the 1600 \wn bandhead of the water vapor spectra, CKD 2.4 continuum is 
inaccurate. Looking at radiance spectra from various downlooking instrument, 
it produce transmittances that are too high (leading to radiances that give 
brightness temperatures which are about 1-2 K too high). Analysing high 
spectral resolution data from the Rutherford Appleton Laboratory gives the same
conclusion. More specifically, the RAL data implies that the CKDv2.4 continuum
is too small, both for the self and foreign parts of the continuum.
Analysing the RAL laboratory data, we have made corrections to the self and
foreign components of the water continuum in this region. 
Figure \ref{fig:continuum} shows how the coefficients differ. The top panel
shows the foreign coefficents while the bottom panel shows the self 
coefficients for both models, at two different temperatures. In each panel,
solid blue and solid green are the new coefficients, at 240 and 290 K, while
dotted red and dotted cyan are the CKD 2.4 coefficients, at 240 and 290 K, 
respectively. It is evident that our estimates of the coefficients, based on 
analyzing recently acquired laboratory data, are higher than the CKD2.4 
measurements. 

\begin{figure}
\includegraphics[width=5.5in]{EPS_FILES/continuum.eps}
  \caption{CKDv2.4 continuum coefficients, compared to those obtained from 
   Rutherford Appleton Laboratory. Top panel shows the foreign coefficients
   while the bottom panel shows the self coefficients, at two different 
   temperatures}
  \label{fig:continuum} 
\end{figure} 

Figure \ref{fig:continuum_bt} shows the brightness temperature differences 
from AIRS spectra. As usual, the temperature and humidity fields used in the
simulation are from ECMWF. 
%A suite of 800 randomly selected clear night time 
%views from October 13, 2002 are used in this plot. 
While our model might 
appear to give larger errors, especially in the 1600 \wn bandhead, our model 
is far more consistent than the CKDv2.4 model, as will be explained below.

\begin{figure}
%\includegraphics[width=5.5in]{EPS_FILES/g005corrected-a.ps}
\includegraphics[width=6.5in]{EPS_FILES/test.eps}
  \caption{Bightness temperature differences using CKDv2.4 continuum 
   coefficients, compared to those obtained from Rutherford Appleton 
   Laboratory. Top panel shows an averaged AIRS spectrum. The bottom panel 
   shows the BT differences from the two models}
  \label{fig:continuum_bt} 
\end{figure} 

Figure \ref{fig:scatter} shows the brightness temperature difference plotted 
versus brighness temperature, for the CKD 2.4 continuum (left) and our 
continuum (right). Independent of where in the infrared spectrum the radiance
measurement is made, the corresponding brightness temperature roughly tells 
one which portion of the atmosphere the particular channel is looking at; so 
widely varying channels with similar brightness temperatures are roughly 
sensing the same part of the atmosphere. It is clear that the data using our 
continuum lies on a straight line and is therefore more consistent, since 
different spectral regions having the same brightness temperature, have 
roughly the same brightness temperature difference. On the other hand, the 
data using CKDv2.4 is much more scattered, 
with different spectral regions having the same brightness temperature, 
having a far wider range of brightness temperature differences.

\begin{figure}
\includegraphics[width=4.0in]{../EUROPTO/Crete02/SLIDES/MOREFIGS/scatterwaterboth2.eps}
  \caption{Scatter plot in 1200 - 1700 \wn water vapor region, showing
           differencess between CKD2.4 (left) and UMBC-LBL (right) continuum}
  \label{fig:scatter} 
\end{figure} 

The stright line errors shown by our model might imply some problems with the 
ECMWF data fields. We are currently validating AIRS data using ECMWF fields,
ARM CART radiosondes and Lidar data. This is an exhaustive process, and will
take some time before we can come with more definite adjustments to the 
continuum.

\section{Non scattering Radiative transfer algorithm}

The standard Schwartschild equation for time independent radiation
transfer through a plane atmosphere, can be written as
\cite{goo:89,edw:92}
\begin{equation}
R(\nu) = R_{s}(\nu) + R_{layer emission}(\nu) + R_{th}(\nu) + R_{solar}(\nu)
\end{equation}
where the four terms are the surface, layer emissions, downward
thermal and solar respectively. Using an isotropic reflectance of
$1/2\pi$, and denoting the Planck function as $B(T)$, $\epsilon$ as
the surface emissivity, $T_{s}$ as the surface temperature, the
satellite viewing angle as $\theta_{satellite}$, the sun zenith angle
as $\theta_{solar}$, and discretizing the radiative transfer equation,
the above four terms are written out as
\begin{eqnarray*}
R_{s}(\nu) & = & \epsilon B(\nu,T_{s})
\tau_{1 \rightarrow \infty}(\nu,\theta_{satellite})
\end{eqnarray*}
\begin{eqnarray*}
R_{layer emission}(\nu) & = & \sum_{i=1}^{i=N} B(\nu,T_{i})
(\tau_{i+1 \rightarrow \infty}(\nu,\theta_{satellite})-
 \tau_{i \rightarrow \infty}(\nu,\theta_{satellite}))
\end{eqnarray*}
\begin{eqnarray*}
R_{th}(\nu) & = & \frac{1 - \epsilon}{\pi} \sum_{i=N}^{i=1} 
\int_{0}^{2\pi}d\phi 
\int_{0}^{\pi/2} d(cos\theta) cos\theta \times \\ 
& & B(\nu,T_{i})(\tau_{i-1 \rightarrow ground}(\nu,\theta)-
 \tau_{i \rightarrow ground}(\nu,\theta))
\end{eqnarray*}
\begin{eqnarray*}
R_{solar}(\nu) & = & \rho(\nu)
B(\nu,T_{solar})cos(\theta_{solar}) \times \\
& &                 \tau_{N \rightarrow ground}(\nu,\theta_{solar}))
                 \tau_{ground \rightarrow N}(\nu,\theta_{satellite}))
                 \Omega_{solar}
\end{eqnarray*}

where the solar reflectance $\rho(\nu)$ is either known or can be modelled 
in terms of the surface emissivity $\rho = \frac{1 - \epsilon}{\pi}$.
The above terms have been written in terms of layer to space transmittances. 
Alternatively the forward radiative transfer algorithm can easily be written 
iteratively; for example, the first two terms would be rewritten as : 
\begin{equation}
R(\nu) = \epsilon_{s}B(T_{s},\nu) \Pi_{i=1}^{i=N} \tau_{i}(\nu) + \\
         \sum_{i=1}^{i=N} B(T_{i},\nu) (1.0 - \tau_{i}(\nu))\\
         \Pi_{j=i+1}^{N} \tau_{j}(\nu)
\end{equation}
Looking at the second (summation) term, $(1.0 - \tau_{i}(\nu))$ is the 
emissivity of the layer while 
$(1.0 - \tau_{i}(\nu)) \Pi_{j=i+1}^{N} \tau_{j}(\nu)$ is the weighting 
function $W_{i}$ of the layer. Note that \textsf{kCARTA} has been written 
such that layer 1 is the lowest layer (highest average pressure) while layer 
100 is the highest layer (lowest average pressure). In what follows, the 
discretized form of the radiative transfer equation is used.

\subsection{Background thermal radiation}
The above expression for the background thermal radiation $R_{th}$ involves 
an angular integration. While the typical contribution due to this background
thermal can be small (less than 1 K), it is important to be able to 
accurately estimate and include this term. The actual integration over the 
half plane is of the form  
\begin{equation}
    \int_{0}^{2\pi}d\phi \int_{0}^{\pi/2} 
    d\theta \; sin\theta \; cos\theta \; B(T_{i}) 
    \tau_{i \rightarrow ground}(\nu,\theta)
\end{equation}
The mean value theorem can be used to rewrite this expression in terms of a 
single effective diffusive angle $\theta_{d}$ (along with the $2\pi$ factor 
that arises from the azimuthal integration) 
\begin{equation}
   \frac{1}{2} B(T_{i}) \tau_{i \rightarrow ground}(\theta_{d})
\end{equation}

This so-called diffusion approximation \cite{lio:80} reduces the computation 
for the downward thermal contribution to the form
\begin{equation}
    \frac{1}{2}B(T_{i}) \left[ \tau_{i-1 \rightarrow ground}
(\theta_{d1})- \tau_{i \rightarrow ground}(\theta_{d2}) \right] 
\end{equation}
where based on the layer to ground transmissions of the $i,i-1$ $th$
layers,  $\theta_{d1},\theta_{d2}$ are the optimum diffusion angles. 

The value of $\theta_{d}$ that is often used is that of $\arccos(3/5)$ 
\cite{lio:80}, especially for $k \le 1$.  A check of the the accuracy of 
using this angle at all layers and at all wavenumbers was carried out, using 
a selection of some of the AIRS regression profiles. Neglecting
solar radiation, the total radiation at the top of the atmosphere was
computed using the forward model and the reflected background thermal.
The truth for the background thermal was an angular integration over as many
as 40 Gaussian quadrature points in the $(0,\pi/2)$ interval, at each layer 
and at each wavenumber. The test value was obtained by using the diffusive 
angle of $\arccos (3/5)$ in the downward thermal at each layer. As expected,
in the wave number regions where the atmosphere was blacked out, the
diffusion approximation was perfectly acceptable. However where the atmosphere
was transparent, such as the 10 $\mu m$ window region, the errors could be 
larger than 0.2 K, especially if one used realistic land surface emissivity 
values of 0.8.

For the \textsf{AIRS} reference model, or any of the new generation of high 
resolution instruments, it is desirable to keep the brighness temperature 
errors $\le 0.1K$, throughout the wavenumber region encompassed by our 
spectroscopic \textsf{kCARTA} database. This meant that we needed to find a 
more accurate way of computing the background thermal radiation, as follows.
Instead of using the single fixed diffusive angle, an optimum diffusive 
angle was computed (as described below) at each layer and at each wavenumber. 
Rewriting the transmission as 
\[
\tau_{i \rightarrow ground}(\nu,\theta) = 
exp(-\sum_{j=1}^{j=i-1}k_{j}/cos\theta = exp(-k^{(i)}/cos\theta
\]
one can relate the angular integration for $R_{th}$ to the exponential 
integral of the third kind $E_{3}(k^{(i)})$, where 
$k^{(i)} = \sum_{j=i-1}^{j=1}k_{j}$.  This exponential integral can be 
evaluated (e.g. Numerical Recipes, MATLAB toolbox), and the optimum 
diffusion angle $\theta_{d}$ obtained from
\begin{equation}
         \theta_{d}(k^{(i)}) = \frac{- k^{(i)}}{ln (2 E_{3}(k^{(i)}))}
\end{equation}
In the limit
of $k^{(i)} \ll 1$, $\theta_{d} \rightarrow \arccos(0.5)$, while in the limit
of $k^{(i)} \gg 1$, $\theta_{d} \rightarrow \arccos(1.0)$. 

For a discrete set of values of $k^{(i)}$ between 0 and 10, the
diffusion angles were computed and saved. A polynomial fit to the
data, such that errors between the computed diffusion angle and the
polynomial approximations were always less than 0.5\%, was then made.
In this fashion, \textsf{kCARTA} can very quickly compute $\theta_{d}$
for an arbitrary $k^{(i)}$.

The accuracy of this computation was checked by propagating the
thermal background between the top of the atmosphere and the ground
using this polynomial approximation, and comparing it to the results
from the 40 point Gaussian quadrature. This was performed over the 605
to 2830 $cm^{-1}$ region, for a variety of AIRS regression profiles,
The typical brightness temperature error, computing an accurate diffusive 
angle at all layers and at all wavenumbers, was less than 0.001 K.

With the accuracy of the technique being successfully tested, a few 
variations on the technique were tried, to make the radiative transfer code 
run as quickly as possible, finally choosing the following. The 
$\tau(layer \rightarrow ground)$ factor at each level makes it apparent that 
the most significant contribution is from the bottom layers. For the topmost
layers ($100$ down to $J+1$), the simple diffusive approximation was
used (one angle, $\arccos(3/5)$ at all layers). For the bottom $J$
layers, the accurate diffusion angle for calculated for each layer,
based on the polynomial approximation to $\theta_{d}(k(i \rightarrow
ground))$. Assuming that the surface pressure is such that it occurs in one of
the lowest layers ($\leq$ 5), the value of J used produces less than 0.1 K 
errors in all profiles. For instance, where the atmosphere is blacked 
out (e.g. in the water region, about 1500 $cm^{-1}$), a value of $J=6$ was 
sufficient, while a transparent region such as about 2500 $cm^{-1}$, a larger 
value of $J(=30)$ was used. For the sampled profiles, using a surface 
emissivity value of 0.8, this always produced less than 0.1 K brightness 
temperature errors, and had the advantage of being faster than if the angle 
were computed at all layers, for all frequencies.

\subsection{Solar radiation}
The solar contribution is much easier to include than the thermal
contribution; assuming the sun radiates as a blackbody whose
temperature is 5600 K, the solar term that in incident at the earth's
surface is given by
\begin{equation}
 B(5600 K,\nu) \Omega_{solar} \tau(top \rightarrow ground) cos(\theta_{solar})
\end{equation}
where $\Omega_{solar} = \pi(r_{se}/r_{e})^{2}$ is the geometry factor
that accounts for the sun-earth distance and the $cos(\theta_{solar})$
is the geometry factor accounting for the solar radiation coming in at
an angle with respect to the vertical. This solar radiation is then
reflected back up to the instrument; either the surface reflectance $\rho$ is 
specified, or an isotropic reflectance factor of $(1-\epsilon)/\pi$ is used.

Both these thermal/solar radiation terms can be easily turned on/off
before runtime by simply setting relevant parameter switches. In
addition, the thermal contribution can be computed accurately, or by
using the upper level $arccos(3/5)$ approximation/accurate lower level
combination; similarly, we include the use of datafiles that give a more
correct solar beam spectrum incident at the TOA, instead of using 
5600 K throughout.

The code can also compute radiances for an upward looking instrument. Once 
again, this feature can be turned on/off by simply resetting appropriate 
parameters before runtime. Even at the lower layers, the default 100 layering
structure of \textsf{kCARTA} is probably too coarse for an accurate
estimate. This should not present problems, as the user can recompile 
and rerun the code, with a finer set of pressure layers in the lower
atmosphere. 

\subsection{Other features of the Clear Sky Forward Model}

When defining an atmosphere within which to compute radiances, {\sf kCARTA} 
allows the user to define the upper and lower pressure boundaries arbitrarily.
This flexibility allows the user to compute the radiance incident on a 
downward looking instrument that is on board an aircraft or at the top of the 
atmosphere, from a surface at sea level or at the top of a mountain. The 
downwelling solar and background thermal contributions are by default 
computed from the top of the atmosphere down to the surface. At the
surface, the contributions are appropriately weighted by the surface
reflectance, and then the complete upwelling radiance is computed from
the surface to the instrument.

While defining an atmosphere, the user refers to a set of ``mixed
paths'' which is simply a cumulative sum of gas optical depths,
weighted by a user specified amount. By using different mixed paths,
the user can easily make \textsf{kCARTA} compute radiances for different
atmospheres, for example ones in which the amount of water vapor is
slightly different.

In addition to the features mentioned above, the user can include files that 
allow the code to use a spectrally varying surface emissivity or a spectrally 
varying solar reflectivity, as well as change the surface and deep space 
temperatures. The user can also change the satellite viewing angle, as well 
as account for the changes of the local path angle due to the curvature of 
the earth.

\section{Jacobian algorithm}

Consider only the upward terms in the radiance equation (the layer
emission and the surface terms), reproduced here for convenience.
Assuming a nadir satellite viewing angle we have :
\begin{equation}
R(\nu) = \epsilon_{s}B(T_{s},\nu) \tau_{1 \rightarrow N}(\nu) +
\Sigma_{i=1}^{i=N} B(T_{i},\nu) (1.0 - \tau_{i}(\nu)) 
\tau_{i+1 \rightarrow N}(\nu)
\end{equation}

Differentiation with respect to the $m$-layer variable $s_{m}$, (which can be
gas amount or layer temperature $s_{m} = q_{m(g)},T_{m}$)
\[
\frac{\partial R(\nu)}{\partial s_{m}} = \epsilon_{s}B(T_{s}) 
\frac{\partial \tau_{1 \rightarrow N}(\nu)}{\partial s_{m}} +
\sum_{i=1} B(T_{i},\nu) (1.0 - \tau_{i}(\nu))
\frac{\partial \tau_{i+1}(\nu)}{\partial s_{m}} + 
\]
\begin{equation}
\sum_{i=1} \tau_{i+1}\frac{\partial B(T_{i},\nu) (1.0 - \tau_{i}(\nu))}
{\partial s_{m}}
\end{equation}

As usual, $\tau_{m}(\nu) = exp^{-k_{m}(\nu)}$,
$\tau_{m \rightarrow N}(\nu) = \Pi_{j=m}^{N} exp^{-k_{j}(\nu)}$. Performing the
above differentiation,  
\begin{eqnarray*}
\frac{\partial R(\nu)}{\partial s_{m}} & = &
\left[
\epsilon_{s}B(T_{s}) \tau_{1 \rightarrow N} \right]
(-1)\frac{\partial k_{m}(\nu)}{\partial s_{m}} + \\
& & \left[ \sum_{i=1}^{m-1}(1.0 - \tau_{i}(\nu)) B_{i}(\nu) 
\tau(\nu)_{i+1 \rightarrow N}
\right](-1)\frac{\partial k_{m}(\nu)}{\partial s_{m}} + \\  
& & \left[(1.0-\tau_{m}(\nu))\frac{\partial B_{m}(\nu)}{\partial s_{m}} -
B_{m}(\nu)\frac{\partial \tau_{m}(\nu)}{\partial s_{m}}
\right]\tau_{m+1 \rightarrow N}(\nu)
\end{eqnarray*}

The individual Jacobian terms in \textsf{kCARTA} code can then by
obtained as follows. Recall the layer transmission are related to
absorption coefficients by
\begin{equation}
\tau_{m}(q_{m(g)}) = exp^{-k(T_{m})q_{m(g)}/q^{ref(g)}_{m(g)}}
\end{equation}

Then for all gases other than water, using the SVD compressed notation,
\begin{equation}
k_{m(g)}(\nu) = \frac{q_{m(g)}}{q^{ref}_{m(g)}}
                \sum_{l=1}^{L} c_{l(g)}(T_{m},m) \Psi_{l}
\end{equation}
from which the gas amount derivative is simply 
\begin{equation}
\frac{\partial k_{m}}{\partial q_{m(g)}} = \frac{k_{m}}{q_{m(g)}}
\end{equation}

while for water, 
\begin{equation}
k_{m(w)}(\nu) = \sum_{l=1}^{L} c_{l(w)}(T_{m},m,q_{m}) \Psi_{l}
\end{equation}
from which the water amount derivative is 
\begin{equation}
\frac{\partial k_{m}}{\partial q_{m(w)}} = 
\sum_{l=1}^{L} \frac{\partial c_{l(w)}}{\partial q_{m(w)}} \Psi_{l}
\end{equation}

The temperature derivative can similarly be written as
\begin{equation}
\frac{\partial k_{m}}{\partial T_{m}} = 
\sum_{g=1}^{g=G} \sum_{l=1}^{L} 
\frac{\partial c_{l(g)}}{\partial T_{m}} \Psi_{l}
\end{equation}
where the double sum is over the singular vectors and the gases.

While doing the spline interpolations of the coefficients $c_{l(g)}$,
the derivatives $\frac{\partial c_{l(g)}}{\partial T_{m}}$,
$\frac{\partial c_{l(w)}}{\partial q_{m(w)}}$ can be obtained
concurrently \cite{wil:89} in the compressed space.  (These
Jacobians can also be calculated, in compressed space, but by
``perturbing'' the gas amounts/layer temperatures and then doing a
finite difference derivative, before performing the uncompression).
Multiplying by the orthonormal basis matrix $U$ then immediately gives
the analytic derivatives.  Performing the calculations of the
Jacobians in the compressed representation is therefore easily
achieved. As these radiance Jacobians are obtained in 25 $cm^{-1}$
chunks, for all 100 layers, they are easier to obtain than finite
difference Jacobians.  

The solar and background thermal terms for inclusion in the Jacobian
calculations are also included in the algorithm. However, due to the
increase in run-time of the code when computing the Jacobians, the
only possible computation for the thermal background Jacobians is
using the diffusive approximation $\arccos(3/5)$ at $all$ levels,
independent of whether the forward model radiative transfer algorithm
used the accurate computation or the diffusive/accurate combination.
Because of this, there would be slight differences if one compared the
computed Jacobians to those obtained using finite differences between
two almost similar parameterizations of the forward model.

The Jacobians obtained using the compressed representation are much
faster than uncompressing the coefficients, doing a radiative
transfer, perturbing the relevant layer, and doing another radiative
transfer, after which a finite difference radiance Jacobian is
obtained. The reason is easy to see -- one would have to do these
perturbed calculations for $each$ gas amount and or temperature, 
at $each$ layer, instead of obtaining the Jacobians in big chunks.

In addition to the gas amount/layer temperature Jacobians described
above, the Jacobians with respect to the surface temperature and
surface emissivity are also computed. The Jacobian of the background
thermal contribution with respect to the surface emissivity, and the
Jacobian of the solar contribution with respect to the surface
emissivity are also output.  Additionally, weighting functions
$W_{i}(\nu)$ are also computed and output as part of the overall
Jacobian file :
\begin{eqnarray*}
R_{layer emission} (\nu) &  = &
\Sigma_{i=1}^{i=N} B(T_{i},\nu) (1.0 - \tau_{i}(\nu)) 
\tau_{i+1\rightarrow N}(\nu) \\
& = &\Sigma_{i=1}^{i=N} B(T_{i},\nu) W_{i}(\nu)
\end{eqnarray*}

Another feature of the code is that the Jacobians can be output in any
of three modes. The first is a raw $d(radiance)/d(variable)$ mode,
where $variable$ could be gas amount, layer temperature etc. Another
mode is a $\delta(variable \times d(radiance)/d(variable))$ mode, where if
$variable$ is a gas amount, then we have appropriately weighted the
Jacobian with the gas amount at that layer. The third mode is 
$\delta(variable) \times d(brightness temperature)/d(variable)$ mode, where
all the results now are Jacobians with respect to brightness
temperatures.

Once again, the turning on or off of the Jacobians can be achieved
simply by setting the appropriate parameter at run time. Furthermore,
the inclusion of thermal background to the Jacobian can be turned off
(resulting in a significant decrease in run time) at the expense of
incorrectly estimating the Jacobians at the lowest levels (as these
are where the bulk of the background thermal contribution comes from).
The temperature Jacobians can include only the Planck term, or the weighting
function term, or both (see Case Study 2 later). 

\section{Non LTE computations}
Higher up in the atmosphere, the lower gas densities imply fewer collisions, 
which means that the lower and higher state populations of some molecules 
might be better described with a different, non local temperature. This 
usually happens quite high up in the atmosphere (eg above 90 km for the 15 \um
\cd band), where there are very few molecules; this means that the change in 
optical depth in the upper atmosphere is insignificant for a spaceborne 
nadir viewing instrument, leading to unnoticeable changes in observed 
brightness temperature. However, previous studies of the atmosphere by limb 
viewers have shown that for the 4 \um \cd band, the solar pumping very strongly
affects the vibrational temperatures of the transitions in this region; NLTE
can be seen above heights as low as 45 km, where there are enough molecules
present to noticeably alter the optical depths. While this will not affect the 
daytime observations of instruments on board aircraft, spaceborne instruments
such as HIRS and AIRS will certainly see the enhancement in observed brightness
temperatures. HIRS is a radiometer based instrument, with very low resolution;
AIRS is a much higher resolution instrument (the channel widths in this region
are about 2 \wn), from which it should be possible to make spectral 
comparisons between observations and NLTE models.

\kc allows the user to define a separate NON LTE profile for the (vibrational) 
states of one or more bands of (different) molecules. With this information, 
it can compute the NLTE optical depths and Planck function modifiers for 
these user specified choices ``on the fly,'' adding on the ``background LTE'' 
optical depths of the rest of the molecules plus the rest of the states of 
the molecule(s) in question. Having done all this, \kc then computes a 
TOA radiance. At present, the NLTE capabilities of \kc are optimized for the 
4 \um band of \cd; additionally, instead of using linemixing, the Cousin 
lineshape is used as it is a simpler model to incorporate.

\subsection{Computing the optical depths}
Most of the modifications to the code use the standard nonLTE analysis 
\cite{edw:93,edw:98,lop:01,kopra}. Let $T_{l}$ be the local thermodynamic
temperature of layer $l$, while $T_{vib}^{g,l}(i)$ be the NLTE vibrational 
temperature of the $i$th band in question, for gas $g$ at the same layer $l$.
With the vibrational band center denoted by $\nu_{0}$, the optical depths 
at NLTE is related to the LTE optical depth by \\
\[
k_{nlte}^{g,l}(i,\nu_0) q^{g,l} = 
      k^{g,l}(i,\nu_0) \alpha^{g,l}(i,\nu_0) q^{g,l}
\]
where $k^{g,l}(i,\nu_0)$ is the LTE absorption coefficient, $q^{g,l}$ is the
gas amount in lthe layer and $\alpha^{g,l}(i,\nu_0)$ is an
adjustment factor, that depends on the population enhancememt or depletion in
the lower and upper levels of the vibrational transition under consideration.
Let $r_{j}, j = 1,2$ be the population ratios of the lower level ($j=1$) and
upper level ($j=2$); these population ratios are the ratios between the 
level populations $n_{j}$ at NLTE vs LTE : 
\[
r_{1} = \frac{n_{1}^{NLTE}(T_{vib})}{n_{1}^{LTE}(T_{l})} \;\;\;
r_{2} = \frac{n_{2}^{NLTE}(T_{vib})}{n_{2}^{LTE}(T_{l})}
\]
Letting $g_1,g_2$ be the Boltzmann statistical weights of the transition, the
equilibrium population ratio between the upper and lower levels is given by
\cite{edw:93,lop:01}
\[
\Gamma = \frac{g_{1}n_{2}(T_{l})}{g_{2}n_{1}(T_{l})} = 
exp(-hc\nu_{0}/K_{B}T_{l})
\]
The above terms can be combined to \cite{edw:93,lop:01} give an expression for
the adjustment factor
\[
\alpha^{g,l}(i,\nu_0) = \frac{r_1 - r_2 \Gamma}{1 - \Gamma} \times f_{i}
\]
where $f_{i}$ is the correction to the vibration contribution to the partition 
function \cite{edw:93,edw:98}. As the vibrational temperature approaches the
local kinetic temperature, the adjustment factor goes to unity.

Summing over all gases and bands, and using $\zeta(\nu_{0},\nu)$ to denote
the effects of lineshape, we have the following expression for the 
total optical depth $\tau_{l}$ of layer $l$
\begin{eqnarray*}
\tau_{l} & = & 
 \sum_{g,i} \alpha^{g,l}(i,\nu_0) k^{g,l}(i,\nu_0) q^{g,l} \zeta(\nu_{0},\nu)\\
   & =  & \sum_{g,i(LTE)} k^{g,l}(i,\nu_0) q^{g,l} \zeta(\nu_{0},\nu) + 
    \sum_{g,i(NLTE)} \alpha^{g,l}(i,\nu_0) k^{g,l}(i,\nu_0) q^{g,l} 
                 \zeta(\nu_{0},\nu)
\end{eqnarray*}
where we have broken the optical depth into the NLTE contribution (consisting 
of the vibrational bands of the gas(es) in question) and the LTE contribution 
($\alpha = 1$, consisting of the weaker bands as well as other gases). 
As the vibrational temperature approaches the local kinetic temperature, the 
adjustment factor goes to unity, which leaves the optical depths unchanged.

\subsection{Computing the source term for radiative transfer equation}

The simple, nonscattering 1D radiative transfer equation is given by
\[
\mu \frac{dI(\nu)}{dk_{a}} = -I(\nu) + J(\nu)
\]
where J is the source function, usually taken to be the Planck function.

The general source function for a two level system is given by 
\cite{edw:93,edw:98,lop:01}
\[
J(\nu,T_{l}) = 2 h c^{2} \nu^{3} [\frac{n_{1}g_{2}}{n_{2}g_{1}} - 1]^{-1}
\]
Using the expression for $\Gamma$ above, at LTE this reduces to the 
usual Planck source function 
\[
B(\nu,T_{l}) = 2 h c^{2} \nu^{3} [exp(+hc\nu_{0}/K_{B}T_{l}) - 1]^{-1}
\]
while for the general NLTE case, this term can be written as
\[
J(\nu,T_{l}) = 
   2 h c^{2} \nu^{3} [\frac{r_{1}}{r_{2}} exp(+hc\nu_{0}/K_{B}T_{l}) - 1]^{-1}
\]

The source term in the solution to the radiative transfer equation can then be
rewritten as \cite{edw:93,edw:98,lop:01,kopra} $\beta^{g,l}(i,\nu_0) 
B(\nu,T_{l})$ where for one individual line, 
\[
\beta^{g,l}(i,\nu_0) = \frac{ r_{2}^{g,l} k^{g,l}(i,\nu_0) q^{g,l}}
 {\alpha^{g,l}(i,\nu_0) k^{g,l}(i,\nu_0) q^{g,l}}
\]
Generalizing for a sum over many lines, 
\[
\beta_{l} = \sum_{g,i} \beta^{g,l}(i,\nu) =  
   \frac{ \sum_{g,i} 
       r_{2}^{g,l}(i,\nu_0) k^{g,l}(i,\nu_0) q^{g,l} \zeta(\nu_{0},\nu) } 
   {\sum_{g,i}  
     \alpha^{g,l}(i,\nu_0) k^{g,l}(i,\nu_0) q^{g,l} \zeta(\nu_{0},\nu)}
\]
Just as was done for $\tau_{l}$ above, both the numerator and denominator can
be broken down into sums over the LTE and NLTE components, so that an overall
numerical answer for $\beta_{l}$ can be computed easily.
As the vibrational temperature approaches the local kinetic temperature, the 
adjustment factor goes to unity, which makes the Planck modification factor 
also tend to unity.


\subsection{Solution to the Radiative Transfer Equation}
Assume that the radiation incident one one side (say the bottom) of a layer is
$I(\nu)_{l-1}$. The complete solution to the radiative transfer equation, which
gives the radiation exiting the other side (say the top) of the layer is then
\cite{edw:93,edw:98,lop:01,kopra}
\[
I(\nu)_{l} = I(\nu)_{l-1}exp(-{\tau_{l}}) 
             + B(T_{l}) \beta_{l} [1 - exp(-{\tau_{l}})]
\]
where $\tau_{l}$ is given by the expression for total optical depth, and 
$\beta_{l}$ is the Planck function modifier, both given above.

Figure ~\ref{fig:nlte} shows a comparison plot of kCARTA vs GENLN, compared 
to some actual NLTE data seen in daylight viewing conditions on the AIRS 
instrument. Plotted for AIRS, is actual NLTE dayime observations minus LTE 
Fast Model computations, averaged over about 100 spectra taken on 
August 31, 2002. For KCARTA and GENLN2, we plot (NLTE - LTE) 
calculations, with the TOA at about 85 km. The main CO2 $\Sigma-\Sigma, 
\Delta-\Delta, \Pi-\Pi$ bands are in NLTE while the weak background lines are 
in LTE. The Cousin lineshape is used in the simulations.

\begin{figure}
\includegraphics{/home/sergio/KCARTA/DOC/FIG/nlte.eps}
  \caption{Example of a NLTE computation using kCARTA and GENLN2}
  \label{fig:nlte} 
\end{figure} 

\section{TWOSTREAM scattering}

Time independent radiative transfer can be described by Schwartzchild's 
equation \cite{lio:80,goo:89}. As a beam propagates through a medium, the 
change in diffuse beam intensity $I(\nu)$ in a plane parallel medium is 
given by 
\[
\mu \frac{dI(\nu)}{dk_{a}} = -I(\nu) + J(\nu)
\]
where $\mu$ is the viewing angle, $k_{a}$ is the optical depth due to 
absorption, $\nu$ is the wavenumber and $J(\nu)$ is the source function. If 
the medium is nonscattering, such as would be expected in a ``clear sky,'' 
the source function is simply the Planck emission $B(\nu,T)$ at the
layer temperature $T$, implying that there is absoprtion attenuating the beam,
and  Planck emission from the layer adding to the beam. If we assume that the
temperature of the layer is constant, and that the incident intensity is 
$I(\nu,0)$, the equation is trivial to solve : 
\[
I(\nu,k_{a}) = I(\nu,0) e^{-k_{a}/\mu} + B(\nu,T)(1 - e^{-k_{a}/\mu})
\]
$1-e^{-k_{a}/\mu}$ is the emissivity $E$ of the layer, $e^{-k_{a}/\mu}$ is 
the transmission of the layer, and the reflection $R$ is 0. One can see that 
$R+T+E = 1$ in this simple case. Since the atmosphere is not isothermal, it 
is best modeled by dividing it up into layers thin enough that the 
temperature variation across each layer does not give significant 
spectroscopic variation between the layer top and bottom. Having obtained 
the one layer solution, it is trivial to propagate the radiation through 
successive layers and compute the radiation incident at the instrument. 

If the atmosphere is to be modeled more realistically, the effects of 
clouds and/or aerosols should be included. As above, there will be 
a reduction of the diffuse intensity $I(\nu,k_{e})$ by single scattering and
absorption (where $k_{e}$ is the extinction crosssection, which is the sum 
of absorption $k_{a}$ and scattering $k_{s}$ cross sections) 
\cite{lio:80,goo:89}
\[
\mu \frac{dI(\nu)}{dk_{e}} = -I(\nu)
\]
The layer Planck emission $B(\nu,T)$ still contributes to the source function 
$J(\nu)$. However, to maintain thermal equilibrium, only the absorptive 
portion of the extinction is included, and so the contribution to the
source term is now
\[
B(\nu,T) \frac{k_{a}}{k_{e}} = B(\nu,T) \left(1 - \frac{k_{s}}{k_{e}} \right) 
\]

In addition, we need to include scattering of diffuse intensities at 
other angles $\mu\prime$ into the viewing angle, which in three dimensions 
would be given by \cite{lio:80,goo:89}
\[
dI(\nu,\Omega,k) = k_{s} \mu \int_{4\pi} I(\Omega,\Omega\prime,k) 
P(\Omega,\Omega\prime) d(\Omega\prime)
\]
as well as the scattering of the direct solar beam into the viewing beam
\cite{lio:80,goo:89}
\[
dI(\nu,\Omega,k) = k_{s} \mu I_{sun}(\Omega,\Omega_{sun},k) 
P(\Omega,-\Omega_{sun}) 
\]
Here $P(\Omega,\Omega\prime)$ is the phase function, which gives the 
probability of scattering from solid angle $\Omega\prime)$ to solid angle
$\Omega$. The phase function and the extinction properties of the layer are
computed using electromagnetic theory; if one assumes that the particles are
spheres such as would be the case of raindrops in a cloud, then Mie theory 
\cite{van:82,lio:80,boh:98} can be used to determine these properties; if
one wants to describe the scattering properties of ice particles in a high
altitude cirrus cloud, one could use more elaborate ray tracing programs to 
determine these properties. 

If we consider  the azimuthally symmetric case, the phase function is now 
\cite{lio:80}
\[
P(\mu,\mu\prime) =  \frac{1}{2\pi} \int_{0}^{2\pi} 
P(\mu,\phi;\mu\prime \phi\prime) d\phi\prime
\]

Defining the single scattering albedo as
 $\omega_{0} = \frac{k_{s}}{k_{s}+k_{a}}$, and pulling together all of
the above, we finally have the radiative transfer equation to be solved 
\cite{lio:80,goo:89}
\[
\begin{array}{ccc}
\mu \frac{dI(\nu)}{dk_{e}} & = & I(\nu) - B(\nu,T)(1-\omega_{0}) - \\
& & 
\frac{\omega_{0}}{2}\int_{-1}^{+1} I(\nu,k_{e},\mu\prime) P(\mu,\mu\prime)
d(\mu\prime) - 
\frac{\omega_{0}}{4\pi} \pi I_{sun} P(\mu,-\mu_{sun}) e^{-k_{e}/\mu_{sun}} 
\end{array}
\]

This is an integrodifferential equation, which means that obtaining
the intensity at an arbitary viewing angle $\mu$ requires knowledge of the 
intensity at various angles, as one needs to perform an integral of these
intensities, weighted by the phase function. One way of evaluating the 
integral is by
Gaussian Legendre quadrature, which minimises the error in the integral by
picking a set of points over the $[-1,+1]$ interval. Depending on the number
of quadrature points chosen, we have an $n$ stream solution. Some scattering
packages such as \textsf{DISORT} and \textsf{CHARTS} allow the user to pick
the number of streams used. Others such as \textsf{RTSPEC} have a fixed 
number of streams. This should not be a very serious problem, as the large 
number of scatterers actually smooths out the phase function \cite{dee:98}, 
and a twostream solution can be quite accurate. The \textsf{RTSPEC} package
includes both the radiative transfer algorithm as well as Mie scattering code
to compute the particle scattering properties (more accurately, the scattering
properties of a distribution of particles). This package, as well as 
\textsf{DISORT} has been interfaced with \textsf{kCARTA}. 

To be able to compute the radiance when a cloud is present, as well as a 
solar beam, we also developed a simple multilayer \textsf{kTWOSTREAM} 
scattering package. This combines the twostream speed of \textsf{RTSPEC} and 
allows the user to include solar beam scattering (\textsf{DISORT} also allows
beam scattering, but is more slow). The atmosphere is divided up into three 
regions : clear from 
Top-Of-Atmosphere to CloudTop, cloudy, and clear from CloudBottom to Ground.
While simple clear sky radiative transfer is computed in the clear layers, the
reflection, transmission, emission and solar components at the twostream 
angles ($R,T,E,B$) and viewing angle ($r,t,e,b$) are computed for each cloudy
layer, with the layers being added together if the cloud is a multilayer one.
This gives the overall reflection, transmission, emission and beam 
scattering parameters of the cloud.
 
For both a downlook as well as an uplook instrument, we first compute the 
background thermal radiation that makes it down to the surface. 
When including the cloud layer in this initial computation, only the 
absorptive contribution of the cloud extinction depth is included. If the sun
is ``on'', a similar computation of the direct solar beam component at the
Earth's surface is performed. Together with surface emission, and the 
reflection of the background thermal and solar radiations, we propagate two 
beams back to the cloud bottom : one beam at viewing angle $\theta$ and a 
beam at the twostream angle $\arccos(1/\sqrt3)$. Similarly we compute the 
radiation incident downwards at the cloud top at stream angle 
$\arccos(1/\sqrt3)$ (and if necessary, the direct solar beam intensity that 
is incident at the cloud top, at solar angle $\theta_{sun}$). 

Having initialised the boundary conditions, we can propagate the up- and down-
going stream radiations (at $\pm arccos(1/\sqrt(3))$) throught the cloud, 
after which we can compute either the upgoing radiation at cloud top, or down 
going radiation at cloud bottom, at the viewing angle. The third and final 
stage is to compute the radiation to the instrument.

Since the sun creates a natural asymmetry in the radiative transfer, we 
choose to merge the cloud layers from top to bottom. Another point to mention 
is that we compute the reflection, transmission and emission coefficients for 
arbitrary viewing angle, and so a casual check of these coefficients would 
make it seem that $r+t+e$ is not energy conserving (i.e. is not 1). However, 
if one limits the computations to a viewing angle that corresponds to that of 
the two streams, then energy is indeed conserved ($R+T+E = 1$, the uupercase 
denoting the coefficients at the stream angles while the lower case denotes
them at arbitrary viewing angle). 

To agree with the clear sky outputs of \textsf{RTSPEC} and \textsf{DISORT}, 
the only layer temperature variation is exponential-in-optical depth in the 
cloudy layers; 
for the clear layers, we use the average temperature of the layer (which 
agrees very well with the linear-in-tau clear layer variation used in the 
above mentioned packages. However, depending on the wavenumber region, it is
apparent that the authors of the various scattering packages might need to 
agree on the exponential-in-tau variation both in cloudy and clear layers, as 
this could lead to brightness temperature differences of upto 0.6 K.

The layer addition is done in much the same fashion as is presented in Goody 
and Young \cite{goo:89}. The two stream equations are exactly solved for 
the layer in question (note that we define $k=0$ at the bottom of the 
layer, and that there is an implicit wavenumber dependence $\nu$) : 

\[
\begin{array}{ccc}
\mu_{+} \frac{dI^{+}}{dk} & = & -I^{+} + \frac{\omega_{0}}{2} 
(I^{+}(1 + 3g\mu_{+} \mu_{+}) + I^{-}(1 - 3g\mu_{+} \mu_{+})) + \\
                             & & B_{b}(1-\omega_{0})e^{\beta k} + 
\frac{\omega_{0}}{4}S_{T}e^{-(T-k)/\mu_{sun)}}P(\mu_{+},-\mu_{sun})
\end{array}
\]

\[
\begin{array}{ccc}
-\mu_{+} \frac{dI^{-}}{dk} & = & -I^{-} + \frac{\omega_{0}}{2} 
(I^{+}(1 - 3g\mu_{+} \mu_{+}) + I^{-}(1 + 3g\mu_{+} \mu_{+})) + \\
                            & & B_{b}(1-\omega_{0})e^{\beta k} + 
\frac{\omega_{0}}{4} S_{T} e^{-(T-k)/\mu_{sun}}P(-\mu_{+},-\mu_{sun})
\end{array}
\]

where we define
\[
\begin{array}{lcl}
\mu_{+}            & & \mbox{upgoing stream angle} \\
\mu_{-}            & & \mbox{downgoing stream angle} = -\mu_{+} \\
I^{+}              & & \mbox{upgoing stream intensity} \\
I^{-}              & & \mbox{downgoing stream intensity} \\
k               & & \mbox{optical depth} \\
$T$           & & \mbox{layer total optical depth (0 at bottom, T at top)} \\
\omega_{0}         & & \mbox{layer single scattering albedo} \\
$g$         & & \mbox{layer asymmetry factor} \\
B_{b}        & & \mbox{radiance at bottom of layer} \\
T_{b}        & & \mbox{temperature at bottom of layer} \\
T_{t}        & & \mbox{temperature at top of layer} \\
\beta        & & 1/T log_{e}(T_{t}/T_{b}) \\
S_{T}        & & \mbox{solar radiance at top of layer} 
\end{array}
\]

The homogeneous part of this set of coupled equations is easily solved, giving
the two eigenvalues for the two streams; the inhomogeneous part corresponding 
to the layer temperature variation and the solar beam incident on the top of 
the layer is also easily solved. The boundary conditions are the incident
upward radiance at the bottom of the layer, and the incident downward 
radiance at the top of the layer. With this information, the twostream 
problem is completely solved for one layer.

For a multilayer cloud, at each spectral point, one could make the intensities
continuous across layer boundaries. The drawback is that a potentially large 
matrix (depending on the number of layers the cloud occupies) would need to 
be inverted for each spectral point, making computations tedious. An 
alternative is to rewrite the exact solutions for one layer in terms of the 
monolayer reflection $R$, transmission $T$, layer 
emission $E$ and beam $B$ coefficients. One can show that $R+T+E = 1$ in this 
case. Having the solution for one layer, we can then add the layers together 
to obtain the solution for a multilayer cloud. It is easily appreciated 
that at each spectral point the only computations used in this multilayer 
model are simple multiplications and additions, instead of matrix inversions.

Using the two stream solution, the problem for arbitrary angles can now be 
solved. The radiative transfer equation in this case can be written as 
(for $\mu \geq 0$)

which can more easily be written as 
\[
\begin{array}{ccc}
\mu \frac{dI}{dk} & = & -I + J\prime(k,I^{+}(k),I^{-}(k))
\end{array}
\]

where $J\prime(k,I^{+}(k),I^{-}(k))$ is the (Eddington's second 
solution) source function

\[
\begin{array}{ccc}
J\prime(k,I^{+}(k),I^{-}(k)) & = & \frac{\omega_{0}}{2} \left(
(I^{+} + I^{-}) + 3g\mu \mu_{+}(I^{+} - I^{-}) \right) \\
                             & & B_{b}(1-\omega_{0})e^{\beta k} + 
\frac{\omega_{0}}{4}S_{T}e^{-(T-k)/\mu_{sun)}}P(\mu,-\mu_{sun}) \\
\end{array}
\]

Since we already know the solutions to the twostream radiances $I^{+},I^{-}$,
this general equation can be exactly solved as well. The solution can be 
written as
\[
\begin{array}{ccc}
I(k,\mu) = \left( I(0,\mu) + S_{up}(k) \right) e^{-k/\mu}
\end{array}
\]
where $S_{up}(k)$ is a term that includes the scattering from the twostream
radiances into the view angle stream, as well as layer emission and 
scattering from the solar beam into the viewing angle. A similar set of 
equations can be written and solved for $\mu \leq 0$. Having obtained the one
layer solution for arbitrary angles, we can rewrite the solutions in terms 
of the more general refection, transmission, emission and beam coefficients
$(r,t,e,b)$ and then add layers together for a complete solution. Note that 
because there is scattering from other beams into the viewing beam, $r+t+e$ 
is not necessarily equal to one in this general case. 

Since the code computes the twostream radiation incident at the top and
bottom of the multicloud layer, as well as the radiation incident at the
viewing angle, it can now propagate the twostream radiances through the cloud 
in either direction, and use that to compute the radiation exiting the cloud 
at the viewing angle. The final stage of the computation is to propagate the 
radiation through the remaining clear sky to the instrument.

\section{\textsf{kCARTA} package, hardware issues and algorithm overview}

The kCompressed Database is stored in binary files that contain 
the information for a specific gas, for a preset 25 $cm^{-1}$ chunk.  It is 
available in two formats, one for little-endian machines (e.g. Intel) and one 
for big-endian machines (e.g. MIPS). 

Along with the kCompressed Database, we supply a set of regression profiles 
that include the US Standard Profile and five AFGL profiles (which include
the Tropical, Midlatitude and Artic Profiles).  
\textsf{kCARTA} needs to read in a layer averaged atmosphere profile. We 
include a program (called \textsf{kLAYERS}) that takes in any of these (or 
other user supplied) point profiles and outputs a 100 layer path averaged 
profile. This package is interfaced with the \textsf{AIRS RTP} file format, 
allowing a user to take in a \textsf{AIRS Level 2} product and compare 
the measured radiances to those obtained by running the supplied profile 
through \textsf{kCARTA}. The \textsf{kLAYERS,kCARTA} package has a set of 
built-in pressure levels; an experienced user can modify these levels to suit
his/her needs. Having finished a run, the user can study the results using
our supplied \textsf{MATLAB} and f77 readers for the resulting 
\textsf{kCARTA} binary files. 

\textsf{kCARTA} has been written in f77, and needs a (text) input control file,
which is in a namelist style.  We include the \textsf{BLAS} library files, so 
that fast matrix multiplication routines can be linked in. The 
\textsf{AIRS RTP} files would need f77 compilers that can handle the use of 
structures. Our code has been successfully run on Intel machines running 
LINUX, and on UNIX machines such as SGI, HP and Sun workstations.

Before compiling the code, the user has to set desired array sizes and 
file paths, by editing a simple parameter file. Thus for instance, 
the maximum number of gases 
to be included in an atmosphere can be changed, the user can save memory by 
reducing the allocation set aside for Jacobian computations, or the paths 
to the compressed database can be updated.

After successful compilation, and assuming all directory search paths have 
been correctly set up in the parameter file, the code is ready to run.  
\textsf{kCARTA} is command line driven - at the UNIX prompt, the user types in
\begin{center}
{\em kcarta.x driver.nml output.file [jacob.file]} 
\end{center}
This makes the executable \textsf{kCARTA} code read in the {\em driver.nml}
driver namelist file. While parsing in this namelist file, \textsf{kCARTA} 
searches for a set of 
required keywords that define needed sections, such as those which tell the 
code the wavenumber boundaries, or which atmosphere profile to read in. A few 
other keywords are considered optional, such as the keyword that turns the
Jacobian computations on.  {\em output.file} is the binary file where the
results of the run are stored; if Jacobian computations are turned on, the 
resuults will be stored in {\em jacob.file}.

When the program starts running, it initially performs a series of
quick checks, to ensure that the user defined array sizes and
parameters are internally consistent. It then proceeds to read in the
input namelist file, as well as other files specified in the driver, such as 
the profile, or surface emissivity files, or scattering files.  If it fails 
to successfully parse in any of these  files, error messages are printed and
theprogram halts. If it successfully reads in the specified 
files, it will then proceed to the main part of the code, which it does in
25 $cm^{-1}$ wavenumber chunks. The main portion of the code proceeds through 
a set of two nested loops. The outermost loop is wavenumber chunk, while the 
inner loop is gas ID. For each wavenumber chunk, as the gas spectra are 
uncompressed, the cumulative sum is stored in a matrix. If necessary, output 
of individual gas spectra/mixed path spectra is performed at the relevant
layers. If an atmosphere has been specified, and radiances are to be output, 
the forward model subroutine is then called, with the radiances from the 
user specified layers being output. Finally, if Jacobian and/or flux 
calculations have been switched on, they are performed and the results
output. The program then loops on to the next wavenumber region, and
proceeds as described above. Jacobians can be computed only if clear sky
radiances are being computed.

The output results are stored in (a) binary file(s), which can easily be read 
in by FORTRAN and MATLAB readers that we supply. The beginning of the output 
datafile has header information that reproduces 
some details from the input driver file, such as the gas amounts, layer 
temperatures and atmosphere boundary conditions. After this comes the actual 
data, which could consist of individual gas spectra, mixed path spectra or 
radiances. The Jacobian and/or flux data files, if produced, follow roughly 
the same format. The output binary files are in the ``monochromatic'' point 
spacing of 0.0025\wn; they can be read in and postprocessed as appropriate. 
For example, the radiances could be convolved so that measurements from an 
instrument could be compared to simulations. Or layer to space transmittances
can be obtained from the optical depths for all 100 layers; they can be 
convolved, and then used for developing a Fast Model. All this is illustrated
in Figure \ref{fig:flow}

\begin{figure}
\includegraphics[width=5.5in]{EPS_FILES/flow.eps}
  \caption{Flow diagram for \textsf{kCARTA}}
  \label{fig:flow} 
\end{figure} 

We now present some timings obtained on an Intel Pentium machine, running at 
800 MHz.  The kCompressed database occupies about 450 Mb of space, and can
be obtained from us either on a CD or by direct FTP. If Jacobians are 
required, the compiled code would need a minimum of about 260 Mb of memory; if
only computing radiances and transmittances, about half that amount is 
needed. Depending on the size of the scattering tables used, the scattering
code can use between 500Mb-1000Mb of memory. 

The times shown below are for the entire 605-2830 \wn spectral 
interval covered by the current \kc database.  Typically the runs use an 
atmosphere extending almost from layer 1 (1100 mb) all the way upto layer 
100 (0.005 mb).

The \textsf{RTSPEC, kTWOSTREAM} and clear sky computations are at $each$ 
spectral point, while the \textsf{DISORT} computations are for an 8 stream
run done at one of every 20 or 400 wavenumber points with the results being 
interpolated in wavenumber. For a downlook instrument, the wavenumber 
interpolation done for \textsf{DISORT} compares quite favorably with the other
two codes, even if \textsf{DISORT} is run at the corse spacing of once every 
400 points; for an uplook instrument, we find we needed to run \textsf{DISORT}
at a finer spacing of about once every 50 or 20 points. Note that 
the timings for a downlook instrument have a viewing angle less than the solar
angle; if the opposite is true, \textsf{DISORT} runs more slowly.

\begin{tabular}{lcccc}
\hline
DESCRIPTION & DOWNLOOK  & DOWNLOOK   & UPLOOK & UPLOOK \\
            & Time      & Time       & Time      & Time       \\  
            & (no sun)  & (with sun) & (no sun)  & (with sun) \\
            & (minutes) & minutes    & (minutes) & minutes    \\  \hline

One clear & 13   & 13  & 11 & 12 \\ \hline

One cloudy      & & & & \\ 
\textsf{kTWOSTREAM} & 16 & 16 & 16 & 15 \\ \hline
\textsf{RTSPEC}    & 15 & -  & 17 & -   \\ 
\textsf{DISORT-400}    & 15 & 15 & 13 & 13 \\ 

One clear, four cloudy  & &  &  & \\ 
\textsf{kTWOSTREAM} & 33 & 33 & 28 & 35 \\ 
\textsf{RTSPEC}    & 33 & -  & 37 & - \\ 
\textsf{DISORT-400}    & 27 & 28 & 18 & 25 \\ 
\textsf{DISORT-20}    & 122 & 131 & 115 & 125 \\ 
\hline

\end{tabular}
\newline

These times include uncompressing the kCompressed Database for all the 
relevant gases, and computing the total optical depth (this typically would 
take as little as 10 seconds per 25 \wn chunk). A typical Jacobian run for one
gas, all temperaturtes and weighting functions would take about three times 
as long as a complete (clear sky) radiance run.

A number of groups presently use \textsf{kCARTA}. These include groups at 
NASA-JPL (AIRS science team), at the United Kingdom Meterological Office and 
the University of Wisconsin. The Canadian Weather Forecasting Center will be
using the kCompressed Database to come up with their own set of lookup tables.

We now present three different uses of \textsf{kCARTA}. The first uses the
water amount Jacobians, while the second investigates the sizes of the 
relevant contributing terms to the temperature Jacobians. The third compares
the three scattering algorithms, and compares to actual observations. 

\section{Case Study 1 : Sensitivity to upper tropospheric water vapor}
To illustrate the capabilities of \textsf{kCARTA}, two wavenumber
regions were chosen in the infrared to study which of three different 
instruments would be most effective in determining the amount of water
vapor in the upper troposphere.  The first is the AIRS (Atmospheric
InfraRed Sounder) instrument, which is designed to make measurements
of the Earth's surface and atmosphere. This high resolution
spectrometer (typically about 1 $cm^{-1}$ in the wavenumber regions
used for the study) will have nearly 2400 channels in the infrared
region, specifically selected to make measurements of temperature and
humidity. Second is the IASI instrument (Infrared Atmospheric Sounding
Instrument), which is a high resolution Michelson interferometer
having a resolution of 0.5 $cm^{-1}$, and will be used to determine
temperature profiles.  Last is the IMG instrument (Interferometric
Monitor for Greenhouse Gases), a high resolution interferometer having
a resolution of 0.1 $cm^{-1}$. While the first two instruments will be
on future satellites, this third instrument has already been launched.
However, it has since met its demise, but it had already produced
large amounts of data.

To perform the study, \textsf{kCARTA} computed Jacobians with respect to 
water amount and temperature, in the wavenumber regions between 
655-855 $cm^{-1}$ and 1305-1805 $cm^{-1}$. Note that \textsf{kCARTA} breaks 
water into three components, according to the CKD definition 
\cite{tob:95} : the ``without basement term'' and the ``self'' and 
``foreign'' continuums. 
When studying the water spectroscopy, these three components terms have to be 
added together to evaluate the total effect; conversely the individual terms 
indicate which is the most important. For example, a quick comparison of the
the optical depths in the 805-1005 \wn region demonstrates that the ``self''
continuum dominates, while in the 1500-1600 \wn region, the ``foreign'' 
continuuum is much stronger than the ``self'' continuum; however, the major
temperature dependancies come from the ``lines'' themselves.

The monochromatic Jacobians from \textsf{kCARTA} were then convolved
with the spectral response functions of the three instruments. Five
profiles were used : US Standard Profile and five AFGL Profiles
(Tropical, MidLatitude Summer and Winter, and SubArtic Summer and
Winter). Though the specific results would depend on the profile in question, 
we choose to focus on the US Standard Profile here.

%these files are in /salsify/scratch2/Sergio/PAPER97
%files waterstuff.mat has the stuff raf1,jaciasi
% raf2,jaairs    raf3,jacimg
%plotjac(1,-1,20,90,100,1500,1605,jacairs*0.1,raf2,jaciasi*0.1,raf1,
% jacimg*0,1,raf3)

The first plot shows the AIRS Jacobians on top. The Jacobians are with 
respect to water vapor amount, and show how the temperature would change as a 
result of a +10\%
perturbation in the water vapor amount. Uncompressing the database, doing 
radiative transfer and computing 97 layer water amount and temperature 
jacobians and weighting functions, from 1480 \wn to 1630 \wn, took about 
130 seconds on an 800 MHz Intel machine. The axis labels on the left
are pressures in millibar, while the horizontal axis is in \wn. The
areas in the AIRS Jacobian that are constant for certain wavenumbers
are regions where there are no AIRS channels.  As expected, if one
increases water vapor amounts, the optical depths near the surface are
increased, and the downlooking instrument cannot see as deeply into
the atmosphere. Thus it sees regions higher up in the atmosphere,
where temperatures are lower. Consequently, the Jacobians are less
than zero.  A similar convolution with the IMG instrument functions would 
demonstrate that, due to the higher resolution of the IMG instrument,
there are a couple of regions (near 1560 \wn and 1575 \wn) very high
in the atmosphere, where this instrument could ideally have been used
to determine water amounts. However, for the channels in question,
when one integrates down the atmosphere, most of the sensitivity in
those channels is lower down, and so in reality it is not conceivable
that these channels would be able to retrieve the water amounts very
high up in the atmosphere.

%>> [rad,w]=readkcstd('waterrad.dat'); 
%>> [jacall,w]=readkcjac('waterjac.dat');
%>> ind=1:100:60000; 
%>> jacT = jac(ind,97*3 + (1:97));          %%%temperature jac
%>> jacW = jac(ind,97*0+(1:97))+jac(ind,97*1+(1:97))+jac(ind,97*2+(1:97));
%>>                     %%%gasID 1,101,102
%>> pcolor(w(ind),20:60,jacW(:,20:60)'); shading('interp'); colorbar 
%>> dbt=dBTdr(w(ind),rad(ind))*ones(1,97);        %%%this is dBT/dr
%>> dbtdq=dbt.*jacW;                 %%%this is dBT/dq for delta(q) = 1
%>> duh=load('water.amt'); water=duh(:,5); pressure=duh(:,2);
%>> jac_water=dbtdq.*(ones(length(ind),1)*water(4:100)');
%>> pcolor(w(ind),20:60,0.1*jac_water(:,20:60)'); shading('interp'); colorbar
%>> title('Water amount jacobians for layer 20-60');

%july 2001
%\begin{figure}
%\includegraphics[width=5.5in]{EPS_FILES/waterjac.eps}
%\caption{(top)AIRS Water Jacobians (bottom)IASI Water Jacobians}
%\label{fig:waterAIRS}
%\end{figure}

%july 2001
%\begin{figure}
%\includegraphics[width=5.5in]{EPS_FILES/waterjac.eps}
%\caption{(top)AIRS Water Jacobians (bottom)IASI Water Jacobians}
%\label{fig:waterAIRS}
%\end{figure}

%\begin{figure}
%\includegraphics[width=5.5in]{/salsify/scratch2/Sergio/PAPER97/img_water.eps}
%\caption{IMG Water Jacobians}
%\label{sampleplot}
%\end{figure}

%>> [rad,w]=readkcstd('waterrad.dat'); 
%>> [jac,w]=readkcjac('waterjac.dat');
%>> ind=1:1:length(w);
%>> jacT = jac(ind,97*3 + (1:97));          %%%temperature jac
%>> jacW = jac(ind,97*0+(1:97))+jac(ind,97*1+(1:97))+jac(ind,97*2+(1:97));
%>>                     %%%gasID 1,101,102
%>> dbt=dBTdr(w(ind),rad(ind))*ones(1,97);        %%%this is dBT/dr
%>> dbtdq=dbt.*jacW;                 %%%this is dBT/dq for delta(q) = 1
%>> duh=load('water.amt'); water=duh(:,5); pressure=duh(:,2);
%>> jac_water=dbtdq.*(ones(length(ind),1)*water(4:100)');
%>> d=jac_water; cd SCRIPTS; convolver
%>> cd /home/sergio/KCARTA/WORK
%>> duh=load('water.amt'); water=duh(:,5); pressure=duh(:,2);
%>> pcolor(wave_4a,pressure(20:60)*1013,0.1*conv_4a(20:60,:)); 
%>> shading('interp'); colorbar
%>> %%%%title('Water amount jacobians for 1K change in layer temperature'
%>> pcolor(wave_4a,log10(pressure(1:60)*1013),0.1*conv_4a(1:60,:));  
%>> shading('interp'); colorbar 
%>> xlabel('Wavenumber cm-1'); ylabel('log10(Pressure) mb');           
%>> print -djpeg -zbuffer -r300 waterjac.jpg
%then do jpeg2ps waterjac.jpg > waterjac.eps

\begin{figure}
\includegraphics[width=5.5in]{EPS_FILES/waterjac.eps}
\caption{AIRS Water Jacobians}
\label{fig:waterAIRS}
\end{figure}

\section{Case Study 2 : Contributions of various terms to temperature 
Jacobians}

If one removes the surface, solar and background thermal contributions
from the radiance that one measures at the top of the atmosphere, then
only the layer emission terms contribute :
\begin{equation}
R(\nu) = \Sigma_{i=1}^{i=N} B(T_{i},\nu) (1.0 - \tau_{i}(\nu)) 
\tau_{i+1\rightarrow N}(\nu) = \Sigma_{i=1}^{i=N} B(T_{i},\nu) W_{i}(T_{i})
\end{equation}
where we have rewritten the radiance in terms of the weighting functions $W$

If we compute the radiance using the above expression, errors in the layer 
temperature would manifest themselves in one of two places : in the Planck
term, or in the transmission terms. An investigation of which of these two 
terms dominates would tell us what is required more accurately; the layer 
temperature or the temperature dependance of the spectroscopy. In other words,
differentiating the above equation with respect to the temperature of the 
$m$-th layer, we can separate the resulting Jacobian into the sum of two
contributions :
\begin{eqnarray*}
\frac{\partial R(\nu)}{\partial T_{m}} & =  &
\left[ \sum_{i=1}^{m-1} B(T_{i},\nu) 
      \left\{ \frac{\partial \tau_{i+1 \rightarrow N }(\nu)}{\partial T_{m}} -
      \frac{\partial \tau_{i \rightarrow N}(\nu)}{\partial T_{m}} \right\}- 
\right. \\
 & &  \left .B(T_{m},\nu)\tau_{m+1\rightarrow N}(\nu)  
\frac{\partial \tau_{m}(\nu)}{\partial T_{m}} \right]+ \\
& & \left[ \frac{\partial B(T_{m},\nu)}{\partial T_{m}}
(1.0-\tau_{m}(\nu))\tau_{m+1 \rightarrow N}(\nu)\right] \\
 & =  & \frac{\partial W_{m}}{\partial T_{m}} \; B(T_{m}) +
     \frac{\partial B(T_{m})}{\partial T_{m}} \; W_{m}(T_{m})
\end{eqnarray*}
where the first contribution is that due to the transmission terms
changing because of the temperature change, while the second is that
of the Planck term changing because of the temperature change. 

To compute these terms, the Jacobian subroutines include a runtime switch to 
compute either the weighting function dependance
$\partial W_{m}/\partial T \; B_{m}$ terms, the Planck term dependance 
$\partial B(T)/\partial T \; W_{m}$, or both. To make the comparisons more 
meaningful, the surface emissivity was set at $1.0e^{-5}$ and background 
thermal and solar set to 0.0, so that all terms involving the 
surface emissivity in the radiance calculation were turned off.
As above, these two changes were documented for various US Standard
Profiles, and convolved over the AIRS and IASI instrument functions,
to compare the results.

Before presenting the results, an estimate of the relative sizes is
made.  The Planck radiance, as usual, is given by
\begin{equation} 
B(\nu,T)=\frac{c_{1} \nu^{3}}{exp^{c_{2} \nu/T}-1}
\end{equation} 
where $c_1,c_2$ are the radiative constants, $T$ is the temperature and 
$\nu$ is the wavenumber (in $cm^{-1}$). This expression is easily 
differentiated with respect to temperature, giving estimates for 
$B, \partial B/\partial T$. As is easily verified, for a typical temperature 
of $T \simeq 300 K$, the Planck radiance peaks at about 600 $cm^{-1}$, 
attaining a value of
0.154 Watts m-2 sr-1/ cm-1. On the other hand, for the same
temperature, the derivative peaks at about 800 $cm^{-1}$, with a value
of about $1.75 \times 10^{-3}$ Watts m-2 sr-1/ cm-1 K-1. In the
605-2830 $cm^{-1}$ wavenumber region, the radiance is about 100 times
larger than the derivative in the small wavenumber region, decreasing
to about a factor of 20 times larger in the other end of the infrared
spectrum (2800 $cm^{-1}$ region). Using a typical peak value of a
weighting function as about 0.1, this means that $ \delta B(T) \;
W_{m} \simeq 10^{-4}$.

An estimate of the size of the other term is not so simple, but we
proceed as follows, following Liou \cite{lio:80} and Edwards
\cite{edw:92}.  The transmission (or optical depth) is related to the
monochromatic absorption coefficients by $k(\nu) = exp^{-K(\nu)}$.
In general, for a line whose center frequency is $\nu_{0}$,
$K(\nu,\nu_{0}) = q S(T,\nu_{0}) g(\nu,\nu_{0})$ where $q$ is the gas amount,
$S$ is the line strength adjusted for temperature and $g$ the normalized 
line shape function, which is Lorentz at the lower levels in the atmosphere 
and Doppler at the higher levels.

For an arbitrary temperature $T$, the line strength can be calculated
relative to a reference line strength $S(T_{ref})$
\cite{lio:92,edw:92,goo:89}
\begin{eqnarray*}
S(T) & = & S(T_{ref}) \frac{Q(T_{ref})}{Q(T)}
\frac{exp^{-hcE_{l}/kT}}{exp^{-hcE_{l}/KT_{ref}}} \;
\frac{1-exp^{-hc\nu_{0}/kT}}{1-exp^{-hc\nu_{0}/kT_{ref}}}
\end{eqnarray*}
where $Q$ is the partition function, $E_{l}$ is the energy of the
lower level of the transition and $\nu_{0}$ is the center frequency of
the transition. The expression $exp^{-hcE_{l}/kT}/Q(T)$ is
simply the fractional number of molecules in the lower energy state
$n(E_{1})/n$.  For atmospheric conditions, only the rotation
partition function has a significant temperature dependence, varying
as $T^{n}$ \cite{lio:80} where $n=1$ for linear molecules, and $n=3/2$ for
nonlinear molecules. We can thus rewrite the expression for
the line intensity strength as 
\begin{equation}
S(T) \simeq S(T_{ref}) \left( \frac{T_{ref}}{T} \right)^{n}
\frac{exp^{-hcE_{l}/kT}}{exp^{-hcE_{l}/KT_{ref}}} 
\frac{1-exp^{-hc\nu_{0}/kT}}{1-exp^{-hc\nu_{0}/kT_{ref}}}
\end{equation}

With this as a simple model, we can write the absorption coefficient
as $K = q S_{0} (1/T)^{3/2} exp^{-hcE_{l}/KT} (1-exp^{-hc\nu_{0}/kT}) $. 
Here $S_{0}$ is the line strength, along with other factors such as the 
linewidth term. This clearly implies that $\partial K/\partial T \simeq K/T 
\times factor$; thus as one goes higher in the atmosphere, the gas amount
decrease would lead one to expect $\partial K/\partial T$ to decrease.

By putting in appropriate values of
$S$ and $E_{l}$, such as $E_{l} \simeq 250 k$ and $S \simeq 50,50000$
for a weak line and a strong line respectively, one obtains $\partial
\tau/\partial T ~ \simeq 5 \times 10^{-4}$ for transmissions of about
0.5.  A quick check of this number can easily be made using ${\sf
  kCARTA}$ -- using the US Standard Profile, layer to space
transmissions were computed in the wavenumber region 1055-1080
$cm^{-1}$, and then recomputed for the same profile, but with a 0.1 K
temperature offset. The finite difference temperature derivatives were
on the order of $2 \times 10^{-3}$. Thus using typical Planckian
radiance of 0.1, and the transmission derivative estimate of about
0.001, means that $\delta W_{m} \; B(T) \simeq 10^{-4}$, which is the
same order of magnitude of the $\delta B(T) \; W_{m}$ estimate.

To estimate the size of the $\partial B$ terms compared to the $\partial W$ 
terms, we can proceed as follows. For any layer we compare
\begin{eqnarray*}
\frac{\partial B_{m}}{\partial T_{m}} W_{m} \;\;\;   & :\;\;\;  &
\frac{\partial W_{m}}{\partial T_{m}} B_{m} \\
\end{eqnarray*}

Dividing both sides by $B_{m}W_{m}$ and relating $W_{m}$ to the transmissions
and hence absoprtion coefficients $K_{m}$, we get 
\begin{eqnarray*}
%\frac{\partial B_{m}}{\partial T_{m}} \frac{m}{B_{m}} \;\;\;   & :\;\;\;  &
%\frac{\partial K_{m}}{\partial T_{m}} 
%\frac{\tau_{m \rightarrow N}}{\tau_{2 \rightarrow N}} \frac{m}{m-\tau_{m}}\\
\frac{\partial B_{m}}{\partial T_{m}} \frac{1}{B_{m}} \;\;\;   & : \;\;\;  &
\frac{\partial K_{m}}{\partial T_{m}} \frac{\tau_{m}}{1-\tau_{m}}\\
\end{eqnarray*}

Consider the layer closest to the ground (which is one in \textsf{kCARTA}).
If the wavenumber region is such that the  absorption coefficients are
large ($K_{1} \gg 1$) then the $\partial B_{1}/\partial T$ term dominates, 
as $\tau_{1} \simeq exp^{-K_{1}}$. On the other hand, if the wavenumber 
region of interest is almost transparent, then $K_{1} \ll 1$, and this makes 
the two terms comparable in size.

Now consider layers higher up in the atmosphere. Remebering that the gas 
amounts fall off with height, and that the $\partial K/\partial T$ depends on
$K$, this term rapidly becomes smaller than $\partial B_{m}/\partial T$, 
leading one to expect the $\partial B_{m}/\partial T$ term to dominate.

These estimates were vindicated by the \textsf{kCARTA} runs. In the lowest 
levels of the atmosphere, the two terms were of similar magnitude in the 
window regions, while though small in magnitude, the planck term was larger 
in the ``blacked out'' regions. For both regions, the 
$\delta B(T) \; W_{m}$ began to dominate in the troposphere and above. The 
following figures illustrate the two terms convolved over the AIRS spectral 
response function, for the US Standard Profile. The first set of plots is in 
the 900 \wn window region, while the second set is in the 1500 \wn water 
region.

%%these files are in /salsify/scratch4/Sergio/
%%radiances are in DB_TERMS     saved stuff from ../DK_TERMS/testdkh1JACCON
%%all saved in /DB_TERMS/dbdk.mat
%% plotjac(0,-1,20,90,100,1500,1605,db,raf,dk,raf)    
%% plotjac(0,-1,20,90,100,680,880,db,raf,dk,raf)    

%%>> ind=1:1000:60000; 
%%>> jacT2 = jac2(ind,97*1 + (1:97)); 
%%>> jacT1 = jac1(ind,97*1 + (1:97)); 
%%>> dbt2=dBTdr(w(ind),rad2(ind))*ones(1,97);
%%>> dbt1=dBTdr(w(ind),rad1(ind))*ones(1,97);
%%>> dbt2=dbt2.*jacT2;                       
%%>> dbt1=dbt1.*jacT1;
%%>> figure(2); pcolor(w(ind),lay,dbt2(:,lay)'); shading('interp'); 
%%>> print -depsc2 planck_1405.eps
%%>> caxis([-0.05 0.15]); colorbar; title('planck');
%%>> figure(1); pcolor(w(ind),lay,dbt1(:,lay)'); shading('interp'); 
%%>> caxis([-0.05 0.15]); colorbar; title('tau');   
%%>> print -depsc2 tau_1405.eps   

%%\begin{figure}
%%\includegraphics[width=5.5in]{/salsify/scratch4/Sergio/DB_TERMS/water.eps}
%%\caption{(top)d(Planck)/dT AIRS Temperature Jacobians 
%%         (bottom)d($\tau$)/dT AIRS Temperature Jacobians}
%%\label{sampleplot}
%%\end{figure}

%%july 2001
%\begin{figure}
%\includegraphics[width=6.0in]{EPS_FILES/temper_905.eps}
%\caption{(top)   d($\tau$)/dT AIRS Temperature Jacobians
%         (bottom)d(Planck)/dT AIRS Temperature Jacobians} 
%\label{temp_905}
%\end{figure}

%\begin{figure}
%\includegraphics[width=6.0in]{EPS_FILES/temper_1405.eps}
%\caption{(top)   d($\tau$)/dT AIRS Temperature Jacobians
%         (bottom)d(Planck)/dT AIRS Temperature Jacobians} 
%\label{temp_1405}
%\end{figure}

%%\begin{figure}
%%\includegraphics[width=5.5in]{/salsify/scratch4/Sergio/DB_TERMS/co2.eps}
%%\caption{(top)d(Planck)/dT AIRS Temperature Jacobians 
%%          (bottom)d($\tau$)/dT AIRS Temperature Jacobians}
%%\label{sampleplot}
%%\end{figure}

\section{Case Study 3 : Comparing three scattering codes}

In evaluating the performance and accuracy of the three scattering codes 
included in our \textsf{kCARTA} package, we concentrated on the window regions
in the 10 $\mu m$ and 3.7 $\mu m$ regions. If there is no cloud present, an 
uplooking instrument would look clear into the cold sky in these regions.
However, even though the atmosphere is probably more transparant at 
3.7 $\mu m$ than at 10 $\mu m$, $Planck$ $\times$ $layer$ $emission$ combine 
to give a lower simulated brightness temperature at 10 $\mu m$, which means 
that $BT_{3.7} - BT_{10} \gg 0$. If a cloud is present, the spectral 
signature of the cloud would reduce this brightness temperature difference, 
potentially allowing one to identify cloudy situations. 

The cloud signature depends on factors such as type (ice versus water versus
aerosol type) and the average size and number of particles present; the 
variations in the spectral signature can assist in identifying what type 
of cloud is present. Using the Mie scattering code that is included in the 
\textsf{RTSPEC} package, one can understand the effects that for example 
spherical ice particles would have on the measured radiances. 
Figure \ref{fig:ext_alb_asy} plots the extinction 
optical depths, single scattering albedos and asymmetry factos for two 
ice particle distributions. The mean partice diameters of the two 
distributions are 1.0 to 50.0 $mu m$;  each has an $IcePath$ of 
$1.0 g m^{-2}$. Looking at the extinction depth in the 10.0 $\mu m$ window
region (from about 800 to 1000 \wn), one can readily see there is a sharp 
feature which would manifest itself on the measured radiance. Similarly, the 
single scattering albedo in this region is much less than one, and so a 
simple model, which just adds on the cloud extinction depth to the clear sky 
gas optical depth, can be expected to produxe simulation results that agree 
very well with data.  

These two points combine to lead one to the following conclusions. Without a 
cloud present, the transmittance of the atmosphere in this 10 micron window
region is close to unity. The presence of a cloud would reduce the 
transmittance more at the 800 \wn end than at the 1000 \wn end of the window.
Without a cloud present a downlooking instrument would see clear down to 
the surface, thus enabling a sounding of the temperature of the surface. With
the cloud present, the asymmetric reduction in transmittance would lead to a
lower brightness temperature measured at 800 \wn than at 1000 \wn, with the
cloud spectral signature between these two points. On the other hand, an
uplooking instrument would be able to penetrate to the upper levels of the
atmosphere if no cloud is present, which means the clear sky brightness 
temperatures would be quite low. The presence of a cloud would reduce this
transparecy and the measured radiance would only see closer to the ground 
(higher temperatures) at the 800 \wn end than at the 1000 \wn end. Evidently 
for both uplook or downlook instruments, the clarity of the obtained 
spectral signature would depend on the thickness of the cloud.

Conversely in the 3.7 $\mu m$ region, the asymmetry factor and especially 
the scttering albedo have both increased appreciably towards 1.0, and so a 
more complicated radiative transfer scattering model must be used. Due to
this, one cannot easily use similar reasoning to that above to make
some conjectures about the effects clouds would have on the measured 
radiances. In addition, solar beam scattering is far more important in this 
portion of the infrared.

\begin{figure}
\includegraphics[width=6.0in]{EPS_FILES/ext_alb_asym.eps}
\caption{(a)Extinction optical depths (b) Single scattering albedos and 
(c) Asymmetry factors for five cirrus distributions of IcePath
1.0 $g m^{-2}$. Particles are spheres with mean diameters 1.0 (blue), 
5.0 (green), 10.0 (red), 20.0 (cyan), 40.0 (purple) $\mu m$.}
\label{fig:ext_alb_asy}
\end{figure}

Figure \ref{fig:uplook1} presents a series of \textsf{RTSPEC} simulations 
for an uplooking instrument on top of Mauna Laoa in Hawaii (695 mb), for a US 
Standard Atmosphere. The simulation is run for a nighttime clear sky, as well 
as for 1 km thick cirrus clouds of 1 $\mu m$ average particle size and 
varying IcePath, at a height of 10 km (220-240 mb). 
Figure \ref{fig:uplook40} does the same for cirrus clouds of 40 $\mu m$ 
average particle size and varying IcePath, at the same height of 10 km.

\begin{figure}
\includegraphics[width=5.5in]{EPS_FILES/1um.eps}
\caption{Uplook instrument \textsf{RTSPEC} simulations for cirrus clouds of
average particle diameter 1 $\mu m$}
\label{fig:uplook1}
\end{figure}

\begin{figure}
\includegraphics[width=5.5in]{EPS_FILES/40um.eps}
\caption{Uplook instrument \textsf{RTSPEC} simulations for cirrus clouds of
average particle diameter 40 $\mu m$}
\label{fig:uplook40}
\end{figure}

One can see that the 40 $\mu m$ particles have more scattering effects in the
2700 \wn range, compared to the 1 $\mu m$ particles; the brightness 
temperature is elevated much more in the former case, for the same IcePath. 
Conversely in the 1000 \wn region, the 1 $\mu m$ particles have much more of 
a spectral signature than the 40 $\mu m$ particles. Similar plots and 
reasoning would apply for a downlooking instrument.

To evaluate the three sets of scattering codes, we performed a series of tests
for 6 profiles (US Standard, Tropical, MidLatitude Summer, Midlatitude Winter,
SubArtic Summer, SubArtic Winter). 1 km thick cirrus clouds were typically put
in at a base height of 10 km, and the uplook and downlook radiances computed 
by \textsf{DISORT},\textsf{RTSPEC} and \textsf{kTWOSTREAM} for a variety of 
test scenarios such as instrument in space, or instrument on board an 
aircraft, were compared against each other. The atmospheres included being 
defined from (TOA = 0 mb, GND = 1013 mb) to (TOA = 50 mb, GND = 900 mb). The 
clouds had ice particles ranging from 1 to 40 $\mu m$ in size, with ice paths 
varying between 0.1 to 2.0 $g m^{-2}$, meaning they varied from sub visble to
almost opaque. 

In the window regions, looking in between the lines, with no 
sun on, the three methods typically differed by no more than 3K, both for 
downlook or uplook instruments. In the opaque regions, such as the ozone and 
water regions, there could be larger differences, especially for an uplook 
instrument. With the sun on, differences between by \textsf{DISORT} and 
\textsf{kTWOSTREAM} could begin to get as large as 5K, depending on the 
IcePath/Particle Size combination. Figure \ref{fig:solar_uplook_20um} plots 
the brightness temperature difference between \textsf{DISORT} and 
\textsf{TWOSTRM} for a typical uplooking instrument (mean particle diameter 
of 20 micron), while Figure \ref{fig:solar_downlook_1um} plots the 
brightness temperature difference between \textsf{DISORT} and 
\textsf{TWOSTRM} for an downlooking instrument (mean particle diameter 
of 1 micron). In both plots the differences start to get larger in the region
where the solar beam has an effect; with the solar beam off, the differences
between the two codes is that typical of the rest of the plot (less than 1.5 K
for a downlook instrument, less than 3 K for an uplook instrument).
Typical worst case results have been plotted (1 micron particles for a 
downlook instrument, and 20 micron particles for an uplook instrument). 

It should be remembered that even though \textsf{TWOSTR} is run at the 
monochromatic point spacing, while the radiative transfer computations for 
\textsf{DISORT} are done once every 20 points and then interpolated, the
twostream code is about four times faster. Similar comparisons between
\textsf{DISORT} and \textsf{RTSPEC} (with the sun off) were obtained.

\begin{figure}
\includegraphics[width=5.0in]{EPS_FILES/14.eps}
\caption{Uplook instrument simulations for cirrus clouds of average particle 
diameter 20 $\mu m$} 
\label{fig:solar_uplook_20um}
\end{figure}

\begin{figure}
\includegraphics[width=5.0in]{EPS_FILES/61.eps}
\caption{Downlook instrument simulations for cirrus clouds of average 
particle diameter 1 $\mu m$}
\label{fig:solar_downlook_1um}
\end{figure}

\section{Conclusions}
The \textsf{kCARTA} package offers the user many desirable features. When used
to compute optical depths for an arbitrary Earth atmosphere, it is much faster
than line-by-line codes, and the accuracy of its spectroscopic database has 
been extensively compared  against \textsf{GENLN2}. The computed clear sky 
radiances include an accurate estimate of the background thermal. 
Additionally, analytic temperature and gas amount Jacobians can be rapidly 
computed. Scattering effects due to clouds and/or aerosols can easily be 
included, using one of three scattering codes. While \textsf{DISORT} is a 
standard and well tested package that can include the effect of solar beam 
scattering, it is much slower than another package \textsf{RTSPEC}; however
this does not include the effects of beam scattering. Our =textsf{TWOSTR}
package is rapid and can include the effects of beam scattering, and has been
satisfactorily tested against \textsf{DISORT}.

\section{Acknowledgements}
This work was supported in part by NASA grant number 05-5-28045. We wish to 
thank users of kCARTA that have provided us with feedback. Ji Gou of UMBC 
performed multiple runs of \kc, to assess the different scattering codes. 
Dave Tobin of UW-Madison was instrumental in helping develop the \cd 
linemixing code, as well as modifying the water continuum coefficients. Dave 
Edwards of NCAR provided the {\sf GENLN2} line-by-line code to test the 
{\sf kCompressed} database against, allowed us to use modifications of some of 
his subroutines in {\sf KCARTA}, as well as helped us debug the NLTE code. 
In addition we thank Pat Arnott of the 
Desert Research Institute for motivating discussions about the applicability 
of a single scattering versus twostream approach, Frank Evans of the 
University of Colorado for help in getting RTSPEC interfaced, and Istvan 
Laszlo of University of Maryland, College Park for help in interfacing 
DISORT.

\bibliographystyle{unsrt}
\bibliography{/home/sergio/PAPERS/BIB/atmspec2002}

\end{document}

